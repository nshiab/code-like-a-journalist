---
title: Comment utiliser Svelte
description: Dans cette le√ßon, vous allez apprendre ce qu‚Äôest Svelte et comment l‚Äôutiliser.
---

import { Callout } from 'nextra/components'
import { NoticeIntro, NoticeEnd } from "../../../components/Notices.jsx"

# Comment utiliser Svelte

Vous pouvez cr√©er des projets incroyables en utilisant simplement du HTML, CSS et JavaScript. Mais plus les pages web, les styles et les interactions deviennent compliqu√©s, plus il devient difficile de tout g√©rer.

C‚Äôest pourquoi les *frameworks* web existent. Ce sont des ensembles d‚Äôoutils qui facilitent la cr√©ation de projets web complexes. Vous continuez √† utiliser du HTML, CSS et JS avec eux, mais ils incluent souvent une syntaxe suppl√©mentaire qui simplifie le d√©veloppement.

Il existe de nombreux *frameworks* en code ouvert, mais celui que je trouve particuli√®rement efficace et assez simple √† apprendre est [Svelte](https://svelte.dev/). Il est utilis√© par de nombreuses salles de r√©daction pour cr√©er des visualisations de donn√©es interactives. C‚Äôest ce que nous allons utiliser pour cr√©er une carte interactive des feux de for√™t au Canada.

Avant de commencer, assurez-vous d‚Äôavoir compl√©t√© les sections pr√©c√©dentes, en particulier **1. Premiers pas üßë‚Äçüéì**, **2. Aller plus loin üöÄ**, **3. La librairie SDA ü§ì**, ainsi que les le√ßons sur le **[HTML](/web-basics/html)**, **[CSS](/web-basics/css)** et **[JS](/web-basics/js)**.

<NoticeIntro lang="fr" />

## Installation

Pour installer Svelte, vous pouvez utiliser la librarie [`sv`](https://svelte.dev/docs/cli/overview), mais nous allons plut√¥t utiliser une fois de plus [setup-sda](https://github.com/nshiab/setup-sda) avec l‚Äôoption `--svelte`. Cela installera SDA (comme vu dans **3. La librairie SDA**) et Svelte ensemble, afin de profiter du meilleur des deux‚ÄØ!

Cr√©ez un nouveau dossier, ouvrez-le dans VS Code, puis ex√©cutez `deno -A jsr:@nshiab/setup-sda --svelte`. Cela configurera tout pour vous.

![A screenshot showing VS Code with SDA and Svelte installed.](/assets/web-basics/svelte/setup.png)

Il y a beaucoup de choses dans ce dossier‚ÄØ! Laissez-moi vous expliquer :
- `.svelte-kit` est un dossier utilis√© par Svelte. Vous n‚Äôavez pas √† vous en pr√©occuper.
- `node_modules` contient des librairies. Deno s‚Äôen occupe.
- `sda` est l‚Äôendroit o√π nous allons travailler avec SDA. C‚Äôest le m√™me dossier que celui vu dans **3. La librairie SDA**.
- `src` est le dossier d√©di√© √† notre d√©veloppement web. Il contiendra notre code HTML, CSS, JS et Svelte.
- `static` est un dossier dans lequel placer des ressources, comme des images ou des fichiers de donn√©es. Tout ce qui se trouve ici accompagner votre page web et vous pourrez t√©l√©charger le tout facilement.
- Les autres fichiers sont des fichiers de configuration dont vous n‚Äôavez pas √† vous soucier pour l'instant. La seule exception est `deno.json`, qui contient de nouvelles t√¢ches par rapport aux le√ßons pr√©c√©dentes, comme `dev` et `build`, que nous utiliserons pendant notre d√©veloppement web.

Pour que tout cela fonctionne correctement, nous allons √©galement installer l‚Äô[extension Svelte](https://marketplace.visualstudio.com/items?itemName=svelte.svelte-vscode). Comme l‚Äôextension Deno, elle vous aidera √† coder plus rapidement gr√¢ce √† l‚Äôauto-compl√©tion, aux avertissements et aux erreurs affich√©s pendant que vous travaillez sur vos projets.

![A screenshot showing VS Code Svelte extension.](/assets/web-basics/svelte/svelte-extension.png)

## Donn√©es et prototype

Commen√ßons par traiter nos donn√©es et cr√©er un prototype de visualisation. C‚Äôest souvent la premi√®re √©tape dans mes projets‚ÄØ: utiliser SDA pour traiter/analyser les donn√©es et explorer des options de visualisation.

Comme il s‚Äôagit d‚Äôune le√ßon sur Svelte et que je pars du principe que vous avez compl√©t√© les le√ßons pr√©c√©dentes, nous allons simplement r√©utiliser le code de la le√ßon **[Visualiser des donn√©es](/simple-data-analysis/dataviz)**.

Dans `sda/helpers`, cr√©ez un nouveau fichier `crunchData.ts` et copiez-collez le code ci-dessous.

Ce fichier r√©cup√®re les donn√©es sur les feux de for√™t de 2023 ainsi que les fronti√®res des provinces canadiennes depuis GitHub, puis les pr√©pare pour √™tre visualis√©es.


```ts showLineNumbers filename="sda/helpers/crunchData.ts"
import { SimpleTable } from "@nshiab/simple-data-analysis";

export default async function crunchData(
  fires: SimpleTable,
  provinces: SimpleTable,
) {
  await fires.cache(async () => {
    await fires.loadData(
      "https://raw.githubusercontent.com/nshiab/data-fetch-lesson/refs/heads/main/reported_fires_2023.csv",
    );
    await fires.points("lat", "lon", "geom");
    await fires.addColumn("isFire", "boolean", `TRUE`);
    await fires.sort({ lat: "desc" });
  });

  await provinces.cache(async () => {
    await provinces.loadGeoData(
      "https://raw.githubusercontent.com/nshiab/simple-data-analysis/main/test/geodata/files/CanadianProvincesAndTerritories.json",
    );
  });

  await fires.insertTables(provinces, { unifyColumns: true });
}
```

Cr√©ons maintenant le fichier `sda/helpers/visualizeData.ts` avec le code ci-dessous.

Ce script utilise Plot pour cr√©er une carte √† partir de la table SDA `fires` et l‚Äôenregistre dans `sda/output/map.png`. Si vous souhaitez en savoir plus sur ce code, n‚Äôh√©sitez pas √† consulter la le√ßon **[Visualiser des donn√©es](/simple-data-analysis/dataviz)**.

```ts showLineNumbers filename="sda/helpers/visualizeData.ts"
import { SimpleTable } from "@nshiab/simple-data-analysis";
import { geo, plot, spike } from "@observablehq/plot";

export default async function visualizeData(fires: SimpleTable) {
  await fires.logTable();
  const drawMap = (
    data: { features: { properties: { [key: string]: unknown } }[] },
  ) => {
    const firesPoints = data.features.filter(
      (feature) => feature.properties.isFire,
    );
    const provincesPolygons = data.features.filter(
      (feature) => !feature.properties.isFire,
    );

    return plot({
      projection: {
        type: "conic-conformal",
        rotate: [100, -60],
        domain: data,
      },
      length: {
        range: [1, 200],
      },
      color: {
        legend: true,
      },
      marks: [
        geo(provincesPolygons, {
          stroke: "lightgray",
          fill: "whitesmoke",
        }),
        spike(firesPoints, {
          x: (d) => d.properties.lon,
          y: (d) => d.properties.lat,
          length: (d) => d.properties.hectares,
          stroke: (d) => d.properties.cause,
          fillOpacity: 1,
          fill: (d) => {
            if (d.properties.cause === "Human") {
              return "#b5caff";
            } else if (d.properties.cause === "Natural") {
              return "#ffe6a8";
            } else {
              return "#ffb9ad";
            }
          },
        }),
      ],
    });
  };
  await fires.writeMap(drawMap, "./sda/output/map.png");
}
```

Et nous pouvons maintenant appeler ces fonctions dans `sda/main.ts`.


```ts showLineNumbers filename="sda/main.ts"
import { SimpleDB } from "@nshiab/simple-data-analysis";
import crunchData from "./helpers/crunchData.ts";
import visualizeData from "./helpers/visualizeData.ts";

const sdb = new SimpleDB();
const fires = sdb.newTable("fires");
const provinces = sdb.newTable("provinces");

await crunchData(fires, provinces);
await visualizeData(fires);

await sdb.done();
```

Comme nous l‚Äôavons fait auparavant, nous pouvons maintenant ex√©cuter `main.ts` avec la commande `deno task sda` dans le terminal. Une fois la premi√®re ex√©cution termin√©e, vous verrez la table de donn√©es affich√©e dans le terminal et la carte dans le dossier `sda/output`.

Notre objectif sera de cr√©er le m√™me type de carte sur une page web, mais avec une option pour filtrer les provinces.

![A screenshot showing the fires map in VS Code.](/assets/web-basics/svelte/output-map.png)
<Callout type="info" emoji="üí°">
    Si l‚Äôaffichage de la table semble √©trange dans votre terminal, c‚Äôest probablement parce que sa largeur d√©passe celle de votre terminal. Faites un clic droit dans le terminal et cherchez l‚Äôoption `Toggle size with content width`. Il existe aussi un raccourci pratique que j‚Äôutilise tout le temps pour cela‚ÄØ: `OPTION` + `Z` sur Mac et `ALT` + `Z` sur PC.
</Callout>

## √âcriture des donn√©es pour le web

Pour l‚Äôinstant, nous cr√©ons simplement une carte sous forme d‚Äôimage avec SDA. Mais nous voulons afficher cette carte sur une page web avec Svelte.

La premi√®re √©tape consiste √† √©crire les donn√©es dans un fichier que Svelte pourra utiliser. Nous pouvons faire cela dans `crunchData.ts`. Pour s‚Äôassurer que la page se charge le plus rapidement possible, nous allons s√©lectionner uniquement les colonnes et lignes n√©cessaires √† la visualisation.

Nous pouvons retirer les feux qui n‚Äôont pas de province, et nous n‚Äôavons pas besoin de leurs g√©om√©tries puisque le code de visualisation utilise uniquement les coordonn√©es `lat` et `lon`. En revanche, nous avons besoin de la colonne `geom` pour les fronti√®res provinciales. De plus, nous renommons la colonne `nameEnglish` des provinces en `province` pour conserver leurs noms.

Comme nous allons travailler sur le web, nous pouvons √©crire un fichier JSON que Svelte et n‚Äôimporte quel navigateur web pourront interpr√©ter. Nous enregistrons ce fichier dans `src/data/fires.json`. Tout ce que vous souhaitez utiliser avec Svelte doit se trouver dans le dossier `src`, ce qui est pratique pour distinguer ce qui est destin√© au web et ce qui ne l‚Äôest pas.

Nous pouvons √©galement passer l‚Äôoption `{ rewind: true }` lors de l‚Äô√©criture du fichier, afin de garantir que les coordonn√©es soient dans le bon ordre pour que Plot puisse dessiner la carte correctement. Le fichier `fires.json` devrait peser environ 828‚ÄØKo, et `map.png` devrait toujours s‚Äôafficher sans probl√®me.


```ts showLineNumbers filename="sda/helpers/crunchData.ts" {12, 20, 24-33}
import { SimpleTable } from "@nshiab/simple-data-analysis";

export default async function crunchData(
  fires: SimpleTable,
  provinces: SimpleTable,
) {
  await fires.cache(async () => {
    await fires.loadData(
      "https://raw.githubusercontent.com/nshiab/data-fetch-lesson/refs/heads/main/reported_fires_2023.csv",
    );
    await fires.addColumn("isFire", "boolean", `TRUE`);
    await fires.filter(`province !== null`);
    await fires.sort({ lat: "desc" });
  });

  await provinces.cache(async () => {
    await provinces.loadGeoData(
      "https://raw.githubusercontent.com/nshiab/simple-data-analysis/main/test/geodata/files/CanadianProvincesAndTerritories.json",
    );
    await provinces.renameColumns({ nameEnglish: "province" });
  });

  await fires.insertTables(provinces, { unifyColumns: true });
  await fires.selectColumns([
    "lat",
    "lon",
    "hectares",
    "cause",
    "province",
    "geom",
    "isFire",
  ]);
  await fires.writeGeoData("src/data/fires.json", { rewind: true });
}
```
![A screenshot showing a geojson file being written in VS Code.](/assets/web-basics/svelte/write-file.png)
<Callout type="info" emoji="üí°">
Nous utilisons `writeGeoData` car nous avons des donn√©es g√©ospatiales. Le fichier √©crit est un GeoJSON. Mais si vous souhaitez √©crire des donn√©es tabulaires classiques, vous devez utiliser la m√©thode `writeData`.
</Callout>

## Serveur local

Maintenant que nous avons nos donn√©es, arr√™tons d‚Äôex√©cuter et de surveiller `sda/main.ts` dans le terminal (`CTRL` + `C`) et lan√ßons notre projet Svelte‚ÄØ!

Ex√©cutez `deno task dev` dans votre terminal. Svelte va d√©marrer un serveur local et votre projet web sera accessible √† une adresse locale comme `http://localhost:5173/`. Ouvrez-la avec votre navigateur pr√©f√©r√© et vous verrez votre projet web‚ÄØ!

![A screenshot showing VS Code running a Svelte project and Chrome displaying it.](/assets/web-basics/svelte/start-web.png)

## Explorer `src`

Avant d‚Äôaller plus loin, laissez-moi vous expliquer ce que contient le dossier `src` :
- `components` contient vos composants Svelte, les blocs de construction de vos pages web.
- `data` contient les donn√©es que nous allons utiliser dans notre projet.
- `helpers` servira √† stocker quelques fonctions utilitaires.
- `lib` est un autre endroit o√π vous pouvez stocker des types, des variables, etc., et les importer facilement dans vos composants Svelte.
- `routes` est l‚Äôendroit o√π vous cr√©ez vos pages. On en parle juste apr√®s.
- `app.d.ts` et `app.html` servent √† configurer vos pages.

Tout cela peut sembler beaucoup et assez complexe, mais au fur et √† mesure, vous verrez que c‚Äôest en r√©alit√© une fa√ßon tr√®s agr√©able d‚Äôorganiser le code d‚Äôun projet web.

Et vous vous demandez peut-√™tre : mais o√π est mon HTML‚ÄØ? Si vous jetez un ≈ìil dans `routes`, vous verrez trois fichiers :
- `+layout.svelte` enveloppe chaque page avec ce que vous souhaitez, comme un en-t√™te ou un pied de page. Ici, nous l‚Äôutilisons pour ajouter du CSS par d√©faut (provenant de [Simple CSS](https://github.com/kevquirk/simple.css), comme vu dans la le√ßon **[CSS](/web-basics/css)**).
- `+layout.ts` est un fichier de configuration. Pas besoin de s‚Äôen pr√©occuper.
- `+page.svelte` est votre page principale‚ÄØ! C‚Äôest ici que vous pouvez voir le code HTML affich√© dans Chrome. Dans ce projet, nous avons une seule page, mais Svelte peut tr√®s facilement g√©rer des projets multi-pages. üèãÔ∏è

![A screenshot showing the main page of a Svelte project and Chrome displaying it.](/assets/web-basics/svelte/main-page.png)

## √âcriture du HTML

Nous voulons cr√©er une carte des feux de for√™t filtrable par province. Commen√ßons par mettre √† jour le titre et le paragraphe de notre page.

Nous pouvons modifier la page directement avec du HTML.


```svelte showLineNumbers filename="src/routes/+page.svelte"
<h1>Wildfires in Canada</h1>
<p>
    The map below shows the wildfires reported in 2023. The taller the spikes,
    the larger the fires.
</p>
```

Si vous enregistrez ce fichier, vous verrez que Svelte rafra√Æchit automatiquement la page dans votre navigateur. Cela s‚Äôappelle le *hot reloading* et c‚Äôest tr√®s pratique. Svelte surveille tous les fichiers de votre projet et vous pouvez voir les changements que vous effectuez en direct‚ÄØ! üî•

![A screenshot showing updated HTML code in the Svelte project and in Chrome.](/assets/web-basics/svelte/html-update.png)
<Callout type="info" emoji="üí°">
Dans la capture ci-dessus, j‚Äôai masqu√© le terminal pour avoir plus d‚Äôespace √† l‚Äô√©cran pour coder, mais il tourne toujours. Je n‚Äôai pas arr√™t√© le serveur local de Svelte.
</Callout>

## √âcriture de CSS

Par d√©faut, les projets d√©marr√©s avec la librairie `setup-sda` utilisent [Simple CSS](https://github.com/kevquirk/simple.css). Mais si vous souhaitez ajouter du CSS, vous pouvez utiliser les balises `<style></style>`. Par convention, les styles sont plac√©s en bas des fichiers Svelte.

Par exemple, on pourrait souligner notre `h1`. üíÖ


```svelte showLineNumbers filename="src/routes/+page.svelte" {7-11}
<h1>Wildfires in Canada</h1>
<p>
    The map below shows the wildfires reported in 2023. The taller the spikes,
    the larger the fires.
</p>

<style>
    h1 {
        text-decoration: underline;
    }
</style>
```
![A screenshot showing updated CSS code in the Svelte project and in Chrome.](/assets/web-basics/svelte/css-update.png)

## √âcriture de TypeScript

Dans la le√ßon pr√©c√©dente, nous avons appris que les navigateurs web ne comprennent pas TypeScript. Ils ne peuvent ex√©cuter que du JavaScript. Mais Svelte r√®gle ce probl√®me pour nous. Si on lui donne du TS, il le transpile en JS, ce qui est formidable‚ÄØ!

Pour √©crire du code TypeScript sur notre page, il suffit de l‚Äôencadrer avec les balises `<script lang="ts"></script>`. Par convention, les scripts sont plac√©s en haut des fichiers Svelte.

Par exemple, dans le code ci-dessous, nous importons nos donn√©es de feux, nous les affichons dans la console, puis nous comptons le nombre de feux. Ensuite, nous ins√©rons ce nombre dans notre paragraphe.


```svelte showLineNumbers filename="src/routes/+page.svelte" {1-7} /{nbFires}/
<script lang="ts">
    import fires from "../data/fires.json";

    console.log(fires);

    const nbFires = fires.features.filter((d) => d.properties.isFire).length;
</script>

<h1>Wildfires in Canada</h1>
<p>
    The map below shows the {nbFires} wildfires reported in 2023. The taller the
    spikes, the larger the fires.
</p>

<style>
    h1 {
        text-decoration: underline;
    }
</style>
```
![A screenshot showing updated TS code in the Svelte project and in Chrome.](/assets/web-basics/svelte/ts-update.png)
<Callout type="info" emoji="üí°">
Pour afficher la console et voir les *logs*, cherchez l‚Äôoption `Developer tools` dans les menus de votre navigateur. Vous pouvez cliquer sur ce que vous avez affich√© dans la console pour voir plus de d√©tails, ce qui est pratique avec les listes et les objets.
</Callout>

## Cr√©ation de composants

Dans les le√ßons pr√©c√©dentes, nous avions s√©par√© notre HTML, CSS et JS dans des fichiers `.html`, `.css` et `.js`. L‚Äôid√©e √©tait d‚Äôorganiser notre code par langage ou syntaxe. Mais Svelte permet de faire quelque chose de plus int√©ressant‚ÄØ: les composants.

Les composants permettent de regrouper du HTML, du CSS et du JS/TS li√©s, et peuvent √™tre utilis√©s n‚Äôimporte o√π, autant de fois que vous le souhaitez. üòé

Par exemple, nous pourrions d√©cider que le code que nous avons √©crit jusqu‚Äô√† pr√©sent devrait faire partie d‚Äôun seul composant‚ÄØ: `<Intro />`. Cr√©ez un nouveau fichier `Intro.svelte` dans `src/components` et placez-y tout le code. Par convention, les noms de composants commencent par une majuscule.

PS‚ÄØ: J‚Äôai retir√© le `console.log(fires)`. Nous n‚Äôen avons plus besoin.

```svelte showLineNumbers filename="src/components/Intro.svelte"
<script lang="ts">
    import fires from "../data/fires.json";

    const nbFires = fires.features.filter((d) => d.properties.isFire).length;
</script>

<h1>Wildfires in Canada</h1>
<p>
    The map below shows the {nbFires} wildfires reported in 2023. The taller the
    spikes, the larger the fires.
</p>

<style>
    h1 {
        text-decoration: underline;
    }
</style>

```

Importez ensuite ce nouveau composant dans `src/routes/+page.svelte`. Pour appeler un composant, utilisez son nom comme vous le feriez avec un √©l√©ment HTML, avec `<` et `/>`.

Si vous voulez tester, ajoutez plusieurs fois `<Intro />` √† la suite. Vous verrez que le code est automatiquement r√©utilis√©, et si vous mettez √† jour le composant (en changeant le titre, par exemple), les modifications seront appliqu√©es partout. Tr√®s pratique‚ÄØ!


```svelte showLineNumbers filename="src/routes/+page.svelte"
<script lang="ts">
    import Intro from "../components/Intro.svelte";
</script>

<Intro />
```
![A screenshot showing a Svelte component.](/assets/web-basics/svelte/component.png)

## Composants avec des props

Pour l‚Äôinstant, notre composant `<Intro />` est autonome. Mais que faire si nous voulons lui passer des arguments, comme on le ferait avec une fonction‚ÄØ? Pour cela, nous devons utiliser des `props`, ce qui est l‚Äôabr√©viation de *properties*.

Par exemple, nous pourrions d√©cider que `fires` soit import√© dans `+page.svelte` et transmis √† des composants comme `<Intro />`.

Commen√ßons par mettre √† jour `+page.svelte`.



```svelte showLineNumbers filename="src/routes/+page.svelte" {2} /{fires}/
<script lang="ts">
    import fires from "../data/fires.json";
    import Intro from "../components/Intro.svelte";
</script>

<Intro {fires} />
```
<Callout type="info" emoji="üí°">
`{fires}` est une version raccourcie de `fires={fires}`. Lorsque le nom de la prop est identique √† celui de la variable, vous pouvez utiliser cette syntaxe plus concise. Bien s√ªr, cela implique ici que nous devons cr√©er une prop `fires` dans notre composant `<Intro />`.
</Callout>

Et maintenant, mettons √† jour `Intro.svelte`. Pour r√©cup√©rer la valeur de `fires`, nous devons utiliser la rune `$props()`. Tout ce qui commence par `$` dans Svelte est appel√© une rune. Ce sont des fonctions sp√©ciales de Svelte, disponibles globalement.

Ici, la rune permet de r√©cup√©rer la prop `fires` transmise au composant, afin que nous puissions l‚Äôutiliser √† l‚Äôint√©rieur de celui-ci.


```svelte showLineNumbers filename="src/components/Intro.svelte" {2}
<script lang="ts">
    const { fires } = $props();

    const nbFires = fires.features.filter((d) => d.properties.isFire).length;
</script>

<h1>Wildfires in Canada</h1>
<p>
    The map below shows the {nbFires} wildfires reported in 2023. The taller the
    spikes, the larger the fires.
</p>

<style>
    h1 {
        text-decoration: underline;
    }
</style>
```

Actuellement, les types pour `fires` dans `Intro.svelte` sont assez l√¢ches. Nous pouvons ajouter un type explicite, comme nous le ferions dans une fonction classique, pour nous assurer que la bonne valeur est bien transmise. Ici, le type est un peu complexe parce que nous travaillons avec un GeoJSON, mais ne vous en faites pas. Nous allons nous exercer davantage.


```svelte showLineNumbers filename="src/components/Intro.svelte" {2-4}
<script lang="ts">
    const { fires }: { 
      fires: { features: { properties: { isFire: boolean | null } }[] } 
    } = $props();

    const nbFires = fires.features.filter((d) => d.properties.isFire).length;
</script>

<h1>Wildfires in Canada</h1>
<p>
    The map below shows the {nbFires} wildfires reported in 2023. The taller the
    spikes, the larger the fires.
</p>

<style>
    h1 {
        text-decoration: underline;
    }
</style>
```
![A screenshot showing a Svelte component with props.](/assets/web-basics/svelte/component-props.png)

Ici, utiliser une `prop` peut ne pas sembler tr√®s int√©ressant car nous utilisons `fires` avec un seul composant.

Mais d√®s que vous commencez √† avoir plusieurs composants utilisant les m√™mes donn√©es, cela devient tr√®s utile. Cela √©vite de r√©importer les m√™mes donn√©es ou de recalculer les m√™mes choses plusieurs fois, ce qui permet de garder votre application web rapide et tous vos composants synchronis√©s. üöÄ

## Utilisation des √©tats

### Rune `$state`

Il est maintenant temps de rendre notre projet **r√©actif**. Supposons que nous voulions que l‚Äôutilisateur choisisse une province et que les feux soient filtr√©s selon son choix.

Pour cela, nous avons besoin d‚Äôun √©tat r√©actif, que l‚Äôon peut cr√©er avec la rune [`$state`](https://svelte.dev/docs/svelte/$state). Svelte va automatiquement analyser notre code et mettre √† jour tout ce qui d√©pend de cet √©tat d√®s qu‚Äôil change. C‚Äôest un peu comme les *event listeners* que nous avons vus dans les le√ßons pr√©c√©dentes, mais sous st√©ro√Ødes‚ÄØ! üí•

Dans `+page.svelte`, cr√©ons un √©tat `province`. Au d√©part, la province est `Quebec`.

Ensuite, relions cet √©tat au composant `Select.svelte`, qui a √©t√© cr√©√© lors de la configuration avec `setup-sda`. Le `Select` est un menu d√©roulant qui a besoin de trois props‚ÄØ:
- La valeur, qui est notre √©tat `province`. En utilisant `:bind`, nous indiquons √† Svelte que nous voulons que cet √©tat change en fonction de la valeur s√©lectionn√©e par l‚Äôutilisateur.
- Les options du menu, qui sont les provinces canadiennes.
- Un label, qui est important pour l‚Äôaccessibilit√©.

Pour l‚Äôinstant, passons `province` √† `<Intro />` pour mettre √† jour le titre.


```svelte showLineNumbers filename="src/routes/+page.svelte" {4, 6, 9-26, 27}
<script lang="ts">
    import fires from "../data/fires.json";
    import Intro from "../components/Intro.svelte";
    import Select from "../components/Select.svelte";

    let province = $state("Quebec");
</script>

<Select
    bind:value={province}
    options={[
        "Northwest Territories",
        "Yukon",
        "Nunavut",
        "Alberta",
        "Saskatchewan",
        "British Columbia",
        "Manitoba",
        "Quebec",
        "Newfoundland and Labrador",
        "Ontario",
        "New Brunswick",
        "Nova Scotia",
    ]}
    label="Pick a province:"
/>
<Intro {fires} {province} />
```

Nous mettons ensuite √† jour `Intro.svelte` pour r√©cup√©rer la `province` et mettre √† jour le titre en cons√©quence.

```svelte showLineNumbers filename="src/component/Intro.svelte" {4, 7, 13}
<script lang="ts">
    const {
        fires,
        province,
    }: {
        fires: { features: { properties: { isFire: boolean | null } }[] };
        province: string;
    } = $props();

    const nbFires = fires.features.filter((d) => d.properties.isFire).length;
</script>

<h1>Wildfires in {province}</h1>
<p>
    The map below shows the {nbFires} wildfires reported in 2023. The taller the
    spikes, the larger the fires.
</p>

<style>
    h1 {
        text-decoration: underline;
    }
</style>
```
Maintenant, lorsque vous s√©lectionnez une nouvelle province, Svelte sait que l‚Äô√©tat `province` doit √™tre mis √† jour. Et comme cet √©tat est transmis au composant `<Intro />`, Svelte sait √©galement que ce composant doit √™tre mis √† jour. Magique‚ÄØ! ü™Ñ

![A screenshot showing a Svelte state being updated.](/assets/web-basics/svelte/state.png)
<Callout type="info" emoji="üí°">
N‚Äôh√©sitez pas √† consulter le code du composant `<Select />`. Il est un peu avanc√© pour l‚Äôinstant, mais l‚Äôastuce est d‚Äôutiliser `$bindable()` sur `value`, afin que lorsque l‚Äôutilisateur modifie la s√©lection dans le menu d√©roulant, l‚Äô√©tat `province` soit mis √† jour et propag√© partout o√π c‚Äôest n√©cessaire dans votre application web.
</Callout>

### Rune `$derived`

Mettre √† jour le titre est un bon d√©but, mais nous devons √©galement filtrer les feux.

Pour cela, nous pouvons cr√©er un √©tat **d√©riv√©** avec la rune [`$derived`](https://svelte.dev/docs/svelte/$derived). Dans le code ci-dessous, chaque fois que `province` est mise √† jour, `provinceFires` le sera aussi, et nous pourrons transmettre cet √©tat d√©riv√© √† `<Intro />`.

```svelte showLineNumbers filename="src/routes/+page.svelte" {7-9, 30}
<script lang="ts">
    import fires from "../data/fires.json";
    import Intro from "../components/Intro.svelte";
    import Select from "../components/Select.svelte";

    let province = $state("Quebec");
    let provinceFires = $derived(
        fires.features.filter((d) => d.properties.province === province),
    );
</script>

<Select
    bind:value={province}
    options={[
        "Northwest Territories",
        "Yukon",
        "Nunavut",
        "Alberta",
        "Saskatchewan",
        "British Columbia",
        "Manitoba",
        "Quebec",
        "Newfoundland and Labrador",
        "Ontario",
        "New Brunswick",
        "Nova Scotia",
    ]}
    label="Pick a province:"
/>
<Intro {provinceFires} {province} />
```

Comme nous avons remplac√© `fires` par `provinceFires`, nous devons mettre √† jour `<Intro />`. De plus, nous devons maintenant d√©river `nbFires` puisque `provinceFires` est un √©tat.



```svelte showLineNumbers filename="src/component/Intro.svelte" {3, 6, 10-12}
<script lang="ts">
    const {
        provinceFires,
        province,
    }: {
        provinceFires: { properties: { isFire: boolean | null } }[];
        province: string;
    } = $props();

    const nbFires = $derived(
        provinceFires.filter((d) => d.properties.isFire).length,
    );
</script>

<h1>Wildfires in {province}</h1>
<p>
    The map below shows the {nbFires} wildfires reported in 2023. The taller the
    spikes, the larger the fires.
</p>

<style>
    h1 {
        text-decoration: underline;
    }
</style>
```

N‚Äôest-ce pas g√©nial‚ÄØ? Maintenant, chaque fois qu‚Äôun utilisateur s√©lectionne une province canadienne dans le menu d√©roulant, le titre et le nombre de feux se mettent √† jour instantan√©ment‚ÄØ! ü•≥

![A screenshot showing a Svelte state being derived.](/assets/web-basics/svelte/derived.png)

### Autres runes

Il existe d‚Äôautres runes utiles‚ÄØ:
- [`$inspect`](https://svelte.dev/docs/svelte/$inspect) fonctionne comme un `console.log`, mais pour les √©tats. Elle affiche les √©tats uniquement lorsqu‚Äôils sont initialis√©s ou mis √† jour. Et elle ne les affiche que pendant que vous d√©veloppez votre site web. Une fois le site en production, elle ne loguera plus rien.
- [`$effect`](https://svelte.dev/docs/svelte/$effect) ressemble un peu √† `$derived`, mais est utilis√© pour des op√©rations plus complexes ou pour faire fonctionner certaines librairies. Une chose importante‚ÄØ: elle ne s‚Äôex√©cute que dans le navigateur. Svelte essaie de faire un pr√©-rendu votre page autant que possible lors de la construction du site. Mais ce que vous placez dans un `$effect` ne sera pas pr√©-rendu.

Nous pratiquerons tout cela dans les prochains projets.

## Ajout de la dataviz

Jusqu‚Äô√† pr√©sent, nous avons cr√©√© une carte avec SDA et Plot. La fonction `drawMap` se trouve dans le fichier `sda/helpers/visualizeData.ts`. R√©organisons un peu notre code pour pouvoir l‚Äôutiliser √† la fois avec SDA et avec Svelte.

Cr√©ez un nouveau fichier `drawMap.ts` dans `src/helpers/`. Nous le pla√ßons dans le dossier `src/` (et non `sda/`) pour que Svelte puisse l‚Äôutiliser. Pla√ßons-y la fonction et exportons-la. Nous ajoutons les imports de Plot et transformons la fonction fl√©ch√©e en fonction nomm√©e.


```ts showLineNumbers filename="src/helpers/drawMap.ts"
import { geo, plot, spike } from "@observablehq/plot";

export default function drawMap(
  data: { features: { properties: { [key: string]: unknown } }[] },
) {
  const firesPoints = data.features.filter(
    (feature) => feature.properties.isFire,
  );
  const provincesPolygons = data.features.filter(
    (feature) => !feature.properties.isFire,
  );

  return plot({
    projection: {
      type: "conic-conformal",
      rotate: [100, -60],
      domain: data,
    },
    length: {
      range: [1, 200],
    },
    color: {
      legend: true,
    },
    marks: [
      geo(provincesPolygons, {
        stroke: "lightgray",
        fill: "whitesmoke",
      }),
      spike(firesPoints, {
        x: (d) => d.properties.lon,
        y: (d) => d.properties.lat,
        length: (d) => d.properties.hectares,
        stroke: (d) => d.properties.cause,
        fillOpacity: 1,
        fill: (d) => {
          if (d.properties.cause === "Human") {
            return "#b5caff";
          } else if (d.properties.cause === "Natural") {
            return "#ffe6a8";
          } else {
            return "#ffb9ad";
          }
        },
      }),
    ],
  });
}
```

D√©sormais, `sda/helpers/visualizeData.ts` peut utiliser cette fonction.


```ts showLineNumbers filename="sda/helpers/visualizeData.ts" {2}
import { SimpleTable } from "@nshiab/simple-data-analysis";
import drawMap from "../../src/helpers/drawMap.ts";

export default async function visualizeData(fires: SimpleTable) {
  await fires.logTable();

  await fires.writeMap(drawMap, "./sda/output/map.png");
}
```

Et‚Ä¶ nous pouvons r√©utiliser cette fonction pour notre page web‚ÄØ!

Cr√©ons un nouveau composant dans `src/components/Map.svelte` avec le code ci-dessous.


```svelte showLineNumbers filename="src/component/Map.svelte"
<script lang="ts">
    import drawMap from "../helpers/drawMap";

    const {
        provinceFires,
    }: {
        provinceFires: { properties: { [key: string]: unknown } }[]
    } =
        $props();

    function appendMap(div: Element) {
        const map = drawMap({
            features: provinceFires,
        });

        div.append(map);
    }
</script>

{#key provinceFires}
    <div use:appendMap></div>
{/key}
```

Il se passe beaucoup de choses ici‚ÄØ! Laissez-moi vous expliquer‚ÄØ:
- D‚Äôabord, nous importons notre nouvelle fonction `drawMap`.
- Nous r√©cup√©rons √©galement notre `provinceFires` et son type. Notez que j‚Äôutilise `unknown` comme type pour les propri√©t√©s afin de correspondre aux types attendus par `drawMap`. C‚Äôest un peu approximatif, mais √ßa fonctionne.
- Entre les balises `script`, nous cr√©ons une fonction `appendMap`. Elle attend un √©l√©ment HTML `div`, qui est simplement un √©l√©ment de base vide. Cette fonction appelle `drawMap` puis ajoute la carte g√©n√©r√©e √† la `div`. Notez que nous pla√ßons `provinceFires` dans un nouvel objet pour correspondre √† la structure attendue par `drawMap`.
- Dans le HTML, nous utilisons la syntaxe `#key` avec `provinceFires` pour indiquer √† Svelte de faire un nouveau rendu de tout ce qui se trouve entre `{#key provinceFires}` et `{/key}` lorsque `provinceFires` change. L‚Äôid√©e derri√®re cela est que si `provinceFires` change, cela signifie que nous devons redessiner une nouvelle carte.
- Nous ajoutons notre `div` et nous demandons √† Svelte d‚Äôutiliser notre fonction `appendMap` au moment de son affichage. Ainsi, notre carte sera ajout√©e √† l‚Äô√©l√©ment.

Cela fait beaucoup √† assimiler‚ÄØ! Mais en seulement quelques lignes, ce petit composant fait √©norm√©ment de choses‚ÄØ! Et ne vous inqui√©tez pas, nous allons pratiquer ces techniques. Pour √™tre honn√™te, je copie-colle souvent cette partie depuis mes projets pr√©c√©dents. üòÖ

Ajoutons maintenant ce nouveau composant √† notre page.


```svelte showLineNumbers filename="src/routes/+page.svelte" {5, 32}
<script lang="ts">
    import fires from "../data/fires.json";
    import Intro from "../components/Intro.svelte";
    import Select from "../components/Select.svelte";
    import Map from "../components/Map.svelte";

    let province = $state("Quebec");
    let provinceFires = $derived(
        fires.features.filter((d) => d.properties.province === province),
    );
</script>

<Select
    bind:value={province}
    options={[
        "Northwest Territories",
        "Yukon",
        "Nunavut",
        "Alberta",
        "Saskatchewan",
        "British Columbia",
        "Manitoba",
        "Quebec",
        "Newfoundland and Labrador",
        "Ontario",
        "New Brunswick",
        "Nova Scotia",
    ]}
    label="Pick a province:"
/>
<Intro {provinceFires} {province} />
<Map {provinceFires} />
```

Hmmm‚Ä¶ Il y a un probl√®me avec notre carte. Le petit ‚ö†Ô∏è ajout√© par Plot signifie qu‚Äôun avertissement s‚Äôaffiche dans la console. Nous devons ajuster quelques √©l√©ments dans `drawMap` pour que la projection fonctionne correctement.

![A screenshot showing a problem in a Plot map.](/assets/web-basics/svelte/problem-map.png)

Le probl√®me vient du fait que lorsqu‚Äôil n‚Äôy a qu‚Äôune seule province, Plot ne sait pas trop comment l‚Äôinterpr√©ter. Nous pouvons l‚Äôaider en lui pr√©cisant qu‚Äôil peut la traiter comme une collection de *features* ‚Äî autrement dit, un GeoJSON.


```ts showLineNumbers filename="src/helpers/drawMap.ts" {17-20}
import { geo, plot, spike } from "@observablehq/plot";

export default function drawMap(
  data: { features: { properties: { [key: string]: unknown } }[] },
) {
  const firesPoints = data.features.filter(
    (feature) => feature.properties.isFire,
  );
  const provincesPolygons = data.features.filter(
    (feature) => !feature.properties.isFire,
  );

  return plot({
    projection: {
      type: "conic-conformal",
      rotate: [100, -60],
      domain: {
        type: "FeatureCollection",
        features: provincesPolygons,
      },
    },
    length: {
      range: [1, 200],
    },
    color: {
      legend: true,
    },
    marks: [
      geo(provincesPolygons, {
        stroke: "lightgray",
        fill: "whitesmoke",
      }),
      spike(firesPoints, {
        x: (d) => d.properties.lon,
        y: (d) => d.properties.lat,
        length: (d) => d.properties.hectares,
        stroke: (d) => d.properties.cause,
        fillOpacity: 1,
        fill: (d) => {
          if (d.properties.cause === "Human") {
            return "#b5caff";
          } else if (d.properties.cause === "Natural") {
            return "#ffe6a8";
          } else {
            return "#ffb9ad";
          }
        },
      }),
    ],
  });
}
```
![A screenshot showing an interactive Plot map.](/assets/web-basics/svelte/map-working.png)

Et regardez √ßa‚ÄØ! Maintenant, √ßa fonctionne‚ÄØ! Si vous s√©lectionnez une autre province dans le menu d√©roulant, la carte est redessin√©e avec les donn√©es correspondantes‚ÄØ! N‚Äôest-ce pas incroyable‚ÄØ? ü§†

Il reste encore quelques points que nous pouvons am√©liorer pour rendre le graphique plus clair‚ÄØ:
- Nous pouvons cr√©er une variable bool√©enne `oneProvince` pour d√©tecter si nous dessinons une seule province. Et dans ce cas :
  - Nous limitons la `height` √† 500 pixels‚ÄØ; sinon, nous laissons Plot d√©cider.
  - Nous ajoutons un `insetTop` de 50 pixels pour l‚ÄôAlberta et la Colombie-Britannique afin d‚Äô√©viter que les pics soient coup√©s.
  - Nous utilisons la projection `mercator` sans rotation.
- Pour garantir que l‚Äô√©chelle des hauteurs des pics soit identique pour toutes les provinces, nous ajoutons un domaine √† `length`. Cette √©chelle est li√©e aux valeurs de `hectares` des feux, qui varient de presque 0 √† 1‚ÄØ000‚ÄØ000.
- Certaines provinces incluent toutes les causes, mais d‚Äôautres non. Nous sp√©cifions donc toutes les cat√©gories dans l‚Äô√©chelle de `color`.
- Enfin, nous pouvons ajouter une marque `tip` avec une transformation `pointer` pour afficher une infobulle avec la cause et la superficie br√ªl√©e lorsque l‚Äôutilisateur survole la carte.


```ts showLineNumbers filename="src/helpers/drawMap.ts" {1-2, 14, 17-23, 25-26, 33, 38-39, 62-75}
import { geo, plot, pointer, spike, tip } from "@observablehq/plot";
import { formatNumber } from "@nshiab/journalism/web";

export default function drawMap(
  data: { features: { properties: { [key: string]: unknown } }[] },
) {
  const firesPoints = data.features.filter(
    (feature) => feature.properties.isFire,
  );
  const provincesPolygons = data.features.filter(
    (feature) => !feature.properties.isFire,
  );

  const oneProvince = provincesPolygons.length === 1;

  return plot({
    height: oneProvince ? 500 : undefined,
    insetTop: oneProvince &&
        ["Alberta", "British Columbia"].includes(
          provincesPolygons[0].properties.province as string,
        )
      ? 50
      : 0,
    projection: {
      type: oneProvince ? "mercator" : "conic-conformal",
      rotate: oneProvince ? undefined : [100, -60],
      domain: {
        type: "FeatureCollection",
        features: provincesPolygons,
      },
    },
    length: {
      domain: [0, 1_000_000],
      range: [1, 200],
    },
    color: {
      legend: true,
      domain: ["Human", "Natural", "Unknown"],
      range: ["#4269D0", "#EFB118", "#FF725C"],
    },
    marks: [
      geo(provincesPolygons, {
        stroke: "lightgray",
        fill: "whitesmoke",
      }),
      spike(firesPoints, {
        x: (d) => d.properties.lon,
        y: (d) => d.properties.lat,
        length: (d) => d.properties.hectares,
        stroke: (d) => d.properties.cause,
        fillOpacity: 1,
        fill: (d) => {
          if (d.properties.cause === "Human") {
            return "#b5caff";
          } else if (d.properties.cause === "Natural") {
            return "#ffe6a8";
          } else {
            return "#ffb9ad";
          }
        },
      }),
      tip(
        firesPoints,
        pointer({
          x: "lon",
          y: "lat",
          title: (d) =>
            `Cause: ${d.properties.cause}\nHectares: ${
              formatNumber(d.properties.hectares, {
                suffix: " ha",
              })
            }`,
          fontSize: 12,
        }),
      ),
    ],
  });
}
```
![A screenshot showing our final Observable Plot map.](/assets/web-basics/svelte/map-final.png)

Juste pour v√©rifier que nos modifications n‚Äôont rien cass√© du c√¥t√© de SDA, vous pouvez arr√™ter votre terminal (`CTRL` + `C`) et ex√©cuter `deno task sda`. Vous devriez voir votre table dans le terminal ainsi que la carte du pays entier enregistr√©e en PNG.

C‚Äôest formidable‚ÄØ! Nous utilisons la m√™me fonction pour dessiner notre carte avec SDA et avec Svelte‚ÄØ! C‚Äôest le meilleur des deux mondes. C‚Äôest magnifique. ü•≤

## Construction de votre site web

Jusqu‚Äô√† pr√©sent, nous avons d√©velopp√© notre site web. Il est maintenant temps de le construire.

Dans votre terminal, arr√™tez ce qui est en cours d‚Äôex√©cution et lancez la commande `deno task build`. Cela indiquera √† Svelte de construire une version optimis√©e et minifi√©e de votre code.

Apr√®s quelques secondes, vous devriez voir des fichiers dans le dossier `build`. C‚Äôest votre site web‚ÄØ! Vous pouvez maintenant h√©berger ces fichiers sur un serveur pour partager votre travail avec le monde entier‚ÄØ! üëè

## Conclusion

F√©licitations‚ÄØ! C‚Äô√©tait votre premier projet Svelte‚ÄØ! Vous avez cr√©√© une visualisation de donn√©es interactive pour le Web‚ÄØ! üéâ

Il y avait beaucoup de contenu dans cette le√ßon. Coder pour le Web n‚Äôest pas une t√¢che facile‚ÄØ! Mais avec les prochains projets, vous aurez assez de pratique pour d√©velopper vos propres projets tr√®s bient√¥t.

Si vous souhaitez aller plus loin avec Svelte, je vous recommande de suivre leur excellent [tutoriel](https://svelte.dev/tutorial/svelte/welcome-to-svelte). Il est un peu technique, et vous ne comprendrez peut-√™tre pas tout du premier coup, mais c‚Äôest une excellente ressource.

Vous pouvez aussi explorer l‚Äôexemple fourni avec `setup-sda`. Dans un nouveau dossier, ex√©cutez `deno -A jsr:@nshiab/setup-sda --svelte --example`, puis lancez `deno task dev`. Vous verrez un exemple complet dans votre navigateur, qui utilise tous les composants pr√©configur√©s disponibles dans `src/components`, et vous pourrez explorer le code pour en apprendre davantage.

√Ä tr√®s bient√¥t pour la prochaine le√ßon‚ÄØ! üòä

<NoticeEnd lang="fr" />
