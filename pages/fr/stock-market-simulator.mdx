---
title: Simulateur de march√© boursier üìà
description: Apprenez √† r√©cup√©rer des donn√©es boursi√®res et √† coder un simulateur de rendements avec TypeScript.
---

import { Callout } from "nextra/components";
import { NoticeIntro, NoticeEnd } from "../../components/Notices.jsx";
import YouTube from "../../components/YouTube.jsx"

# Simulateur de march√© boursier üìà

<YouTube videoId="XVVQJFS4sZs" lang="fr"/>

Bienvenue dans ce nouveau projet ! Nous allons r√©cup√©rer des donn√©es historiques du march√© boursier et les utiliser pour estimer combien nous aurions gagn√© ou perdu en investissant dans des entreprises cot√©es en bourse.

Voici √† quoi ressemblera le projet √† la fin. La capture d'√©cran ci-dessous montre le r√©sultat d'un investissement de 1 000 $ dans Apple en janvier 2020, jusqu'en f√©vrier 2025.

Avant de commencer, assurez-vous d'avoir compl√©t√© les sections **Premiers pas üßë‚Äçüéì** et **Aller plus loin üöÄ**. Ce projet est con√ßu pour vous aider √† pratiquer tout ce que nous avons couvert jusqu'√† pr√©sent dans ce cours.

![Une capture d'√©cran de VS Code montrant un script simulant le march√© boursier](/assets/stock-market-simulator/final-result.png)

<NoticeIntro lang="fr"/>

## Quelle est la question ?

Il est toujours important d'identifier clairement la question √† laquelle nous voulons r√©pondre avant de plonger trop vite dans un oc√©an de donn√©es.

Aujourd'hui, notre question est :
- Combien aurions-nous gagn√© ou perdu en investissant dans une entreprise cot√©e en bourse √† une date sp√©cifique ?

Pour y r√©pondre, nous devons calculer la diff√©rence entre le montant initial et le montant final.

Nous pouvons √©galement identifier trois variables qui influenceront le r√©sultat :
- L'entreprise choisie
- Le montant initial investi
- La date de l'investissement

Avec cela en t√™te, commen√ßons !

## Configuration

Cr√©ez un nouveau dossier contenant :
- Un fichier `main.ts` avec `console.log("Hello!");`
- Un fichier vide `deno.json`

Puis ex√©cutez la commande suivante : `deno run -A --watch --check main.ts`

![Une capture d'√©cran de VS Code montrant un script affichant "Hello!" dans le terminal.](/assets/stock-market-simulator/setup.png)

## Les donn√©es

### Yahoo Finance

Pour notre simulateur, nous avons besoin des prix historiques du march√© boursier. L'une des sources les plus courantes pour les donn√©es financi√®res est [Yahoo Finance](https://finance.yahoo.com/).

L'usage d'une petite quantit√© de donn√©es est tol√©r√© pour des fins d'enseignement ou d'int√©r√™t public, mais si vous voulez r√©cup√©rer et r√©utiliser un grand volume de ces donn√©es, avec ou sans objectif commercial, contactez l'√©quipe derri√®re le site ou payez un abonnement premium.

Sur la [page d'accueil](https://finance.yahoo.com/), vous pouvez rechercher une entreprise cot√©e en bourse. Par exemple, recherchez Apple et cliquez sur le r√©sultat correspondant.

![Une capture d'√©cran montrant le site Yahoo Finance.](/assets/stock-market-simulator/search-apple.png)

Vous arriverez sur la page de l'action Apple. Sur le c√¥t√© gauche, cliquez sur *Donn√©es historiques*.

![Une capture d'√©cran montrant le site Yahoo Finance.](/assets/stock-market-simulator/apple-page.png)

Les donn√©es sont maintenant affich√©es sous forme de tableau, ce qui vous permet de r√©cup√©rer toutes les donn√©es disponibles depuis que l'entreprise est entr√©e en bourse. Pour ce faire, cliquez sur le s√©lecteur de dates et choisissez l'option **Max**.

Les colonnes qui nous int√©ressent vraiment sont **Date** et **Adj Close** (prix ajust√© de cl√¥ture).

![Une capture d'√©cran montrant le site Yahoo Finance.](/assets/stock-market-simulator/all-data.png)

Facile, non ? Mais comment pouvons-nous r√©cup√©rer ces donn√©es dans notre script ? ü§î

### Trouver les donn√©es

Ces donn√©es ne viennent pas de nulle part. Elles proviennent probablement d'une API qui les fournit √† la page. Jetons un coup d'≈ìil sous le capot pour en d√©couvrir la source. üßê

<Callout type="info" emoji="üí°">
    API signifie *Application Programming Interface*. Sur le web, les API sont souvent utilis√©es pour transf√©rer des donn√©es. Lorsque vous appelez un point d'acc√®s API (via une URL et parfois des param√®tres), l'API renvoie les donn√©es correspondantes. Les API sont tr√®s utiles pour les sites affichant des donn√©es en temps r√©el, entre autres. Au lieu de reconstruire et republier le site avec de nouvelles donn√©es ‚Äî ce qui peut √™tre lent et co√ªteux ‚Äî il suffit de mettre √† jour les points d'acc√®s de l'API. Les r√©ponses des API sont souvent en JSON, mais elles peuvent aussi √™tre en CSV, XML et d'autres formats.
</Callout>

Notez que j'utiliserai Google Chrome pour les √©tapes suivantes, mais vous pouvez faire la m√™me chose sur Firefox ou Safari.

Ouvrez les *Outils de d√©veloppement* et cliquez sur l'onglet *R√©seau*.

![Une capture d'√©cran montrant le site Yahoo Finance avec les outils de d√©veloppement ouverts.](/assets/stock-market-simulator/network.png)

Cet onglet affiche toutes les requ√™tes effectu√©es par la page. Lorsqu'une page se charge, elle a besoin de diverses ressources, telles que des polices, des images, des styles et... des donn√©es ! Toutes ces requ√™tes sont list√©es ici et vous pouvez les explorer.

Dans notre cas, nous nous int√©ressons aux donn√©es boursi√®res d'Apple affich√©es sous forme de tableau sur la page web.

Rafra√Æchissez la page, puis s√©lectionnez √† nouveau l'option **Max** pour r√©cup√©rer toutes les donn√©es disponibles. Recherchez une requ√™te contenant `AAPL`, qui est le symbole boursier d'Apple. C'est aussi le symbole utilis√© dans l'URL de la page, donc c'est un bon indice.

Vous remarquerez une ou plusieurs requ√™tes fetch commen√ßant par `AAPL`. Cela semble tr√®s prometteur !

![Une capture d'√©cran montrant le site Yahoo Finance avec les requ√™tes r√©seau d√©taill√©es.](/assets/stock-market-simulator/appl-request.png)

Faites un clic droit sur l'une d'elles et ouvrez-la dans un nouvel onglet. Wow ! Vous reconnaissez cette syntaxe ? C'est du JSON ! Et il contient beaucoup de donn√©es. üòè

Voici [le lien](https://query1.finance.yahoo.com/v8/finance/chart/AAPL?events=capitalGain%7Cdiv%7Csplit&formatted=true&includeAdjustedClose=true&interval=1d&period1=345479400&period2=1738778777&symbol=AAPL&userYfid=true&lang=en-CA&region=CA) au cas o√π vous en auriez besoin.

Si vous regardez attentivement l'URL, vous remarquerez des param√®tres comme `symbol`, `interval`, `period1` et `period2`. Il y a aussi les param√®tres `region` et `lang`, qui peuvent √™tre diff√©rents pour vous en fonction de votre localisation.

`https://query1.finance.yahoo.com/v8/finance/chart/AAPL?events=capitalGain%7Cdiv%7Csplit&formatted=true&includeAdjustedClose=true&interval=1d&period1=345479400&period2=1738778777&symbol=AAPL&userYfid=true&lang=en-CA&region=CA`

Explorons cela plus en d√©tail avec du code.

![Une capture d'√©cran montrant l'endpoint de l'API Yahoo Finance.](/assets/stock-market-simulator/raw-data.png)

### R√©cup√©ration des donn√©es

R√©cup√©rons les donn√©es √† partir du point d'acc√®s de l'API que nous venons de d√©couvrir. Pour ce faire, nous pouvons √©crire un script simple comme celui ci-dessous.

```ts showLineNumbers filename="main.ts"
const response = await fetch(
  "https://query1.finance.yahoo.com/v8/finance/chart/AAPL?events=capitalGain%7Cdiv%7Csplit&formatted=true&includeAdjustedClose=true&interval=1d&period1=345479400&period2=1738778777&symbol=AAPL&userYfid=true&lang=en-CA&region=CA",
);

const data = await response.json();

console.log(data);
```

C'est maintenant un peu plus clair.

Les donn√©es sont un grand objet *nested*. Les dates (timestamps) et les prix ajust√©s de cl√¥ture (adjclose) sont stock√©s sous forme de listes.

![Une capture d'√©cran montrant les donn√©es Yahoo Finance dans le terminal VS Code.](/assets/stock-market-simulator/raw-json.png)

Pour les r√©cup√©rer, nous devons parcourir l'objet.

Pour acc√©der aux timestamps, nous devons :
- Obtenir l'objet `chart`  
- Puis r√©cup√©rer la liste `result`  
- R√©cup√©rer le premier √©l√©ment de la liste, qui est un objet  
- √Ä l'int√©rieur de cet objet, obtenir la liste `timestamp`  

Cela ressemble √† ceci.

```ts
const timestamps = data.chart.result[0].timestamp;
```
Pour acc√©der aux prix ajust√©s de cl√¥ture, nous devons :
- Obtenir l'objet `chart`  
- Puis r√©cup√©rer la liste `result`  
- R√©cup√©rer le premier √©l√©ment de la liste, qui est un objet  
- √Ä l'int√©rieur de cet objet, obtenir l'objet `indicators`  
- Ensuite, r√©cup√©rer la liste `adjclose`  
- R√©cup√©rer le premier √©l√©ment de la liste, qui est un objet  
- √Ä l'int√©rieur de cet objet, obtenir les valeurs de `adjclose`  

Cela ressemble √† ceci.

```ts
const values = data.chart.result[0].indicators.adjclose[0].adjclose;
```

Ne vous inqui√©tez pas. Les structures JSON ne sont pas toujours aussi complexes sur le web. Apr√®s quelques projets, vous serez capable de les lire comme un pro ! ü§ì


```ts showLineNumbers filename="main.ts"
const response = await fetch(
  "https://query1.finance.yahoo.com/v8/finance/chart/AAPL?events=capitalGain%7Cdiv%7Csplit&formatted=true&includeAdjustedClose=true&interval=1d&period1=345479400&period2=1738778777&symbol=AAPL&userYfid=true&lang=en-CA&region=CA",
);

const data = await response.json();

const timestamps = data.chart.result[0].timestamp;
console.log(timestamps);

const values = data.chart.result[0].indicators.adjclose[0].adjclose;
console.log(values);
```
![Une capture d'√©cran montrant les timestamps et les valeurs dans le terminal.](/assets/stock-market-simulator/timestamps-values.png)

Pour √©viter d'encombrer le terminal, Deno affiche seulement les 100 premiers √©l√©ments des listes. Mais avez-vous remarqu√© que les listes de timestamps et de valeurs ont le m√™me nombre d'√©l√©ments ?

C'est un tr√®s bon signe.

Cela signifie probablement que le premier √©l√©ment de la liste des timestamps (une date) correspond au premier √©l√©ment de la liste des valeurs (un prix ajust√© de cl√¥ture).

V√©rifions les premiers et derniers √©l√©ments pour en √™tre s√ªrs.

Les timestamps repr√©sentent la dur√©e √©coul√©e depuis le 1·µâ ≥ janvier 1970. Ici, ils semblent √™tre en secondes. Cependant, en JavaScript, les timestamps sont en millisecondes. Nous pouvons facilement ajuster le tout.

```ts showLineNumbers filename="main.ts" {8, 11, 13}
const response = await fetch(
  "https://query1.finance.yahoo.com/v8/finance/chart/AAPL?events=capitalGain%7Cdiv%7Csplit&formatted=true&includeAdjustedClose=true&interval=1d&period1=345479400&period2=1738778777&symbol=AAPL&userYfid=true&lang=en-CA&region=CA",
);

const data = await response.json();

const timestamps = data.chart.result[0].timestamp;
const firstTimestamp = new Date(timestamps[0] * 1000);
const lastTimestamp = new Date(timestamps[timestamps.length - 1] * 1000);

const values = data.chart.result[0].indicators.adjclose[0].adjclose;
const firstValue = values[0];
const lastValue = values[values.length - 1];

console.log({ firstTimestamp, lastTimestamp, firstValue, lastValue });
```

Ce code affiche ces valeurs dans le terminal.

```json
{
  firstTimestamp: 1980-12-12T14:30:00.000Z,
  lastTimestamp: 2025-02-05T14:30:00.000Z,
  firstValue: 0.09883447736501694,
  lastValue: 232.47000122070312
}
```

Apple est bien entr√©e en bourse le 12 d√©cembre 1980 avec un prix par action de 0,10 $, selon [son site web](https://investor.apple.com/faq/default.aspx#:~:text=When%20was%20Apple%E2%80%99s,was%20%24.10.), et la derni√®re valeur correspond √† ce que je vois sur le site de Yahoo au 5 f√©vrier 2025 ! Nous avons nos donn√©es ! ü•≥

![Une capture d'√©cran montrant la valeur de l'action Apple sur le site de Yahoo.](/assets/stock-market-simulator/latest-yahoo.png)

L'URL actuelle est sp√©cifique √† Apple, mais nous voulons que notre code fonctionne avec n'importe quelle entreprise. Extrayons donc certaines valeurs de param√®tres sous forme de variables.

En utilisant des backticks, nous pouvons ins√©rer des variables dans l'URL. Au lieu de ceci :

`https://query1.finance.yahoo.com/v8/finance/chart/AAPL?events=capitalGain%7Cdiv%7Csplit&formatted=true&includeAdjustedClose=true&interval=1d&period1=345479400&period2=1738778777&symbol=AAPL&userYfid=true&lang=en-CA&region=CA`

Nous pouvons g√©n√©raliser l'appel √† l'API en utilisant `${symbol}`, `${period1}` et `${period2}` :

`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?events=capitalGain%7Cdiv%7Csplit&formatted=true&includeAdjustedClose=true&interval=1d&period1=${period1}&period2=${period2}&symbol=${symbol}&userYfid=true&lang=en-CA&region=CA`

Pour `period1`, nous pouvons la d√©finir √† `0`, ce qui correspond au 1·µâ ≥ janvier 1970, puisque les timestamps repr√©sentent la dur√©e √©coul√©e depuis cette date. Pour `period2`, nous pouvons utiliser `Date.now()`, qui retourne le nombre de millisecondes depuis le 1·µâ ≥ janvier 1970, garantissant ainsi que nous r√©cup√©rons les donn√©es les plus r√©centes disponibles.

```ts showLineNumbers filename="main.ts" {1-7}
const symbol = "AAPL";
const period1 = 0;
const period2 = Date.now();

const response = await fetch(
  `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?events=capitalGain%7Cdiv%7Csplit&formatted=true&includeAdjustedClose=true&interval=1d&period1=${period1}&period2=${period2}&symbol=${symbol}&userYfid=true&lang=en-CA&region=CA`,
);

const data = await response.json();

const timestamps = data.chart.result[0].timestamp;
const firstTimestamp = new Date(timestamps[0] * 1000);
const lastTimestamp = new Date(timestamps[timestamps.length - 1] * 1000);

const values = data.chart.result[0].indicators.adjclose[0].adjclose;
const firstValue = values[0];
const lastValue = values[values.length - 1];

console.log({ firstTimestamp, lastTimestamp, firstValue, lastValue });
```

Ce code affiche toujours les bonnes valeurs pour le premier et le dernier √©l√©ment, ce qui signifie que l'API accepte nos param√®tres plus g√©n√©raux !

```json
{
  firstTimestamp: 1980-12-12T14:30:00.000Z,
  lastTimestamp: 2025-02-05T14:30:00.000Z,
  firstValue: 0.09883449226617813,
  lastValue: 232.47000122070312
}
```

En passant, cette technique de collecte de donn√©es s'appelle le *web scraping*. Le web est une source incroyable de donn√©es, et nous aurons une le√ßon compl√®te √† ce sujet plus tard.

<Callout type="info" emoji="üí°">
Comme j‚Äôutilise de temps en temps les donn√©es de Yahoo Finance dans mes projets, j‚Äôai publi√© une fonction qui fait tout cela dans la [librairie journalism](https://jsr.io/@nshiab/journalism/doc/~/getYahooFinanceData). Nous aurions pu l‚Äôutiliser directement, mais je pense qu‚Äôil est tr√®s utile de comprendre comment tout fonctionne avant d‚Äôutiliser des fonctions qui ressemblent √† de la magie‚ÄØ! üßô
</Callout>


## Mise en cache

Actuellement, chaque fois que nous mettons √† jour `main.ts` et que nous l'enregistrons, le code est relanc√© et les donn√©es sont r√©cup√©r√©es √† nouveau.

Nous ne voulons pas surcharger les serveurs de Yahoo avec nos requ√™tes. Nous devons respecter leur infrastructure. De plus, nous ne voulons pas √™tre mis sur une liste noire et nous faire bloquer l'acc√®s... ü´£ Alors, mettons les donn√©es en cache.

La mise en cache peut signifier diff√©rentes choses dans diff√©rents contextes, mais ici, elle consiste simplement √† √©crire les donn√©es dans un fichier local et √† utiliser ce fichier au lieu de r√©cup√©rer les donn√©es √† chaque fois.

En gros, si le fichier local existe, nous devons l'utiliser. Sinon, nous devons r√©cup√©rer les donn√©es.

Pour v√©rifier si le fichier existe d√©j√† sur notre machine, nous pouvons utiliser la fonction `exists` de la librairie standard de Deno [@std/fs](https://jsr.io/@std/fs/doc/~/exists) (*fs* signifie *syst√®me de fichiers*).

Arr√™tez votre terminal et installez-la en ex√©cutant : `deno add jsr:@std/fs`

Ensuite, red√©marrez la surveillance de `main.ts` en ex√©cutant : `deno -A --watch --check main.ts`

Cr√©ez un nouveau dossier appel√© `data`, o√π nous stockerons les donn√©es mises en cache.

Le code ci-dessous g√®re la mise en cache. Voici ce qui se passe lorsque vous l'ex√©cutez :

- Ligne 1 : Nous importons la fonction `exists` de la librairie standard.
- Ligne 6 : Nous utilisons le `symbol` pour cr√©er un chemin d'acc√®s pour les donn√©es mises en cache.
- Ligne 8 : Nous d√©clarons une variable `let` pour les donn√©es.
- Ligne 9 : Nous v√©rifions si un fichier pour cette entreprise existe d√©j√†.
  - Si c'est le cas, nous lisons les donn√©es depuis ce fichier et les assignons √† la variable `data` (ligne 11).
- Si le fichier n'existe pas, les donn√©es ne sont pas mises en cache :
  - Nous les r√©cup√©rons (lignes 14‚Äì16), les convertissons en JSON, et les stockons dans la variable `data`.
  - Ensuite, nous les mettons en cache en √©crivant un fichier JSON √† l'aide du `path` de l'entreprise (ligne 18).
- Lignes 21‚Äì22 : √Ä ce moment-l√†, la variable `data` contient les informations qui ont √©t√© soit lues √† partir d'un fichier local, soit r√©cup√©r√©es de l'API, nous pouvons donc r√©cup√©rer les timestamps et les valeurs !

```ts showLineNumbers filename="main.ts"
import { exists } from "@std/fs";

const symbol = "AAPL";
const period1 = 0;
const period2 = Date.now();
const path = `data/${symbol}.json`;

let data;
if (await exists(path)) {
  console.log("=> Retrieving data from cache...");
  data = JSON.parse(await Deno.readTextFile(path));
} else {
  console.log("=> Fetching data...");
  const response = await fetch(
    `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?events=capitalGain%7Cdiv%7Csplit&formatted=true&includeAdjustedClose=true&interval=1d&period1=${period1}&period2=${period2}&symbol=${symbol}&userYfid=true&lang=en-CA&region=CA`,
  );
  data = await response.json();
  await Deno.writeTextFile(path, JSON.stringify(data));
}

const timestamps = data.chart.result[0].timestamp;
const values = data.chart.result[0].indicators.adjclose[0].adjclose;
```

La premi√®re fois que vous ex√©cutez ce code, vous verrez le message de la ligne 13 s'afficher dans le terminal, et vous remarquerez la cr√©ation d'un nouveau fichier `AAPL.json` dans `data`.

Les donn√©es ont √©t√© r√©cup√©r√©es et √©crites dans un fichier pour une utilisation future. Si vous √™tes curieux, vous pouvez jeter un ≈ìil √† ce qui se trouve dans `AAPL.json` !

![Une capture d'√©cran montrant les donn√©es boursi√®res d'Apple r√©cup√©r√©es.](/assets/stock-market-simulator/data-fetched-aapl.png)

Si vous relancez `main.ts` en l'enregistrant √† nouveau, vous verrez que le message affich√© provient d√©sormais de la ligne 10. Vous utilisez maintenant les donn√©es mises en cache ! Les donn√©es ne sont plus r√©cup√©r√©es depuis l'API, elles sont lues depuis le fichier local.

![Une capture d'√©cran montrant les donn√©es boursi√®res d'Apple mises en cache.](/assets/stock-market-simulator/data-cached-aapl.png)

Vous pouvez conserver des donn√©es en cache pour plusieurs entreprises. Par exemple, remplacez `AAPL` dans la variable `symbol` par `GOOG` pour obtenir les prix historiques des actions d'Alphabet (anciennement Google) et ex√©cutez le code.

Vous verrez qu'un autre fichier, `GOOG.json`, est cr√©√© dans `data`.

Si vous revenez √† `AAPL`, les donn√©es sont toujours l√†. Plus besoin de les r√©cup√©rer √† nouveau !

Et si vous voulez des prix plus r√©cents, il vous suffit de supprimer les fichiers dans `data` et de relancer votre code. Facile !

<Callout type="info" emoji="üí°">
    Ici, nous utilisons la mise en cache pour √©viter de solliciter trop souvent les serveurs de Yahoo. Mais la mise en cache est aussi tr√®s couramment utilis√©e pour am√©liorer les performances. Lire un fichier local est beaucoup plus rapide que de r√©cup√©rer des donn√©es sur Internet.
</Callout>

## Nettoyage

Les valeurs sont des nombres et ne n√©cessitent aucun nettoyage. Cependant, les timestamps ne sont pas tr√®s pratiques √† utiliser. Il serait pr√©f√©rable de les convertir en dates.

Avant de faire cela, nettoyons notre code en encapsulant tout ce que nous avons fait jusqu'√† pr√©sent dans une fonction `getData`. Cela nous aidera √† garder `main.ts` organis√© et rendra notre code plus facile √† comprendre et √† d√©boguer.

Cr√©ez un nouveau dossier appel√© `helpers`, et √† l'int√©rieur, cr√©ez un nouveau fichier nomm√© `getData.ts` avec le code ci-dessous.

Comme nous utilisons `await` dans cette fonction, nous devons la d√©clarer comme une fonction `async`.

Nous garderons `symbol` dans `main.ts`, donc ici, il est pass√© en param√®tre de la fonction.

La fonction retourne les `timestamps` et les `values` sous forme d'un objet.

```ts showLineNumbers filename="getData.ts"
import { exists } from "@std/fs";

export default async function getData(symbol: string) {
  const period1 = 0;
  const period2 = Date.now();
  const path = `data/${symbol}.json`;

  let data;
  if (await exists(path)) {
    console.log("=> Retrieving data from cache...");
    data = JSON.parse(await Deno.readTextFile(path));
  } else {
    console.log("=> Fetching data...");
    const response = await fetch(
      `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?events=capitalGain%7Cdiv%7Csplit&formatted=true&includeAdjustedClose=true&interval=1d&period1=${period1}&period2=${period2}&symbol=${symbol}&userYfid=true&lang=en-CA&region=CA`,
    );
    data = await response.json();
    await Deno.writeTextFile(path, JSON.stringify(data));
  }

  const timestamps = data.chart.result[0].timestamp;
  const values = data.chart.result[0].indicators.adjclose[0].adjclose;

  return { timestamps, values };
}
```

Dans `main.ts`, nous pouvons maintenant importer et utiliser `getData` avec notre `symbol`. Comme il s'agit d'une fonction `async`, nous devons nous assurer de l'appeler avec `await`.

```ts showLineNumbers filename="main.ts"
import getData from "./helpers/getData.ts";

const symbol = "AAPL";

const { timestamps, values } = await getData(symbol);

console.log(timestamps, values);
```
<Callout type="info" emoji="üí°">
    Vous vous demandez peut-√™tre ce qui se passe avec `const { timestamps, values }`. Lorsque vous avez un objet, vous pouvez **le d√©structurer** en extrayant ses cl√©s et en les pla√ßant directement dans des variables portant le m√™me nom. Ici, comme `getData` retourne un objet avec les cl√©s `timestamps` et `values`, nous pouvons le d√©structurer pour cr√©er directement les variables `timestamps` et `values` contenant les donn√©es correspondantes.
</Callout>

Voici √† quoi tout devrait ressembler maintenant. Vous pouvez cliquer sur l'image pour l'agrandir.

![Une capture d'√©cran montrant main.ts et getData.ts.](/assets/stock-market-simulator/refactor.png)

Maintenant, pour nettoyer nos timestamps, cr√©ons une autre fonction, `cleanTimestamps`, dans `helpers`.

Cette fonction attend un param√®tre `timestamps`, qui doit √™tre une liste de nombres, comme indiqu√© par le type `number[]`.

Ces timestamps sont en secondes, mais ils devraient √™tre en millisecondes. Nous les multiplions donc par `1000` avant de cr√©er un `new Date`. Nous utilisons la m√©thode `.map()` sur la liste pour convertir facilement tous les √©l√©ments.

```ts showLineNumbers filename="cleanTimestamps.ts"
export default function cleanTimestamps(
  timestamps: number[],
) {
  console.log("=> Cleaning timestamps...");

  const cleanedTimestamps = timestamps.map((timestamp) =>
    new Date(timestamp * 1000)
  );

  return cleanedTimestamps;
}
```

Nous pouvons importer cette fonction dans `getData.ts` et lui passer les timestamps bruts.

```ts showLineNumbers filename="getData.ts" {2, 22}
import { exists } from "@std/fs";
import cleanTimestamps from "./cleanTimestamps.ts";

export default async function getData(symbol: string) {
  const period1 = 0;
  const period2 = Date.now();
  const path = `data/${symbol}.json`;

  let data;
  if (await exists(path)) {
    console.log("=> Retrieving data from cache...");
    data = JSON.parse(await Deno.readTextFile(path));
  } else {
    console.log("=> Fetching data...");
    const response = await fetch(
      `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?events=capitalGain%7Cdiv%7Csplit&formatted=true&includeAdjustedClose=true&interval=1d&period1=${period1}&period2=${period2}&symbol=${symbol}&userYfid=true&lang=en-CA&region=CA`,
    );
    data = await response.json();
    await Deno.writeTextFile(path, JSON.stringify(data));
  }

  const timestamps = cleanTimestamps(data.chart.result[0].timestamp);
  const values = data.chart.result[0].indicators.adjclose[0].adjclose;

  return { timestamps, values };
}
```

Vous pouvez maintenant voir les timestamps convertis en dates. Le premier est le 12 d√©cembre 1980, date √† laquelle Apple a commenc√© √† √™tre √©chang√© en bourse.

![Une capture d'√©cran montrant les timestamps convertis en dates.](/assets/stock-market-simulator/to-dates.png)

## Restructuration des donn√©es

Actuellement, nous avons deux listes distinctes. Il serait plus pratique d'avoir une seule liste contenant des objets. De plus, nous devons calculer la variation en pourcentage entre chaque jour pour d√©terminer nos rendements d‚Äôinvestissement.

Cr√©ons une nouvelle fonction appel√©e `restructureData.ts` dans le dossier `helpers`. Cette fonction attend deux param√®tres : `timestamps` sous forme de liste de dates et `values` sous forme de liste de nombres.

Nous savons que `timestamps` et `values` ont le m√™me nombre d‚Äô√©l√©ments. Le premier timestamp correspond au premier prix ajust√©, le deuxi√®me timestamp au deuxi√®me prix, et ainsi de suite.

Nous pouvons donc utiliser une boucle pour r√©cup√©rer les valeurs aux m√™mes index dans les deux listes, cr√©er des objets, et les ajouter √† la liste `dailyStockData`. Enfin, nous retournons cette liste.

```ts showLineNumbers filename="restructureData.ts"
export default function restructureData(
    timestamps: Date[],
    values: number[]
  ) {
  console.log("=> Restructuring data...");

  const dailyStockData = [];
  for (let i = 0; i < timestamps.length; i++) {
    const date = timestamps[i];
    const value = values[i];

    dailyStockData.push({
      date,
      value,
    });
  }

  return dailyStockData;
}
```

Nous pouvons maintenant importer et appeler cette fonction dans `main.ts`. Comme `dailyStockData` est une liste d'objets, nous pouvons l'afficher avec `console.table`.

Pour √©viter d'afficher des milliers de lignes dans le terminal, nous utilisons la m√©thode `.slice()` sur la liste pour ne montrer que les 10 premiers √©l√©ments.

```ts showLineNumbers filename="main.ts" {2, 8-10 }
import getData from "./helpers/getData.ts";
import restructureData from "./helpers/restructureData.ts";

const symbol = "AAPL";

const { timestamps, values } = await getData(symbol);

const dailyStockData = restructureData(timestamps, values);

console.table(dailyStockData.slice(0, 10));
```
![Une capture d'√©cran montrant les dates et les valeurs affich√©es sous forme de tableau.](/assets/stock-market-simulator/restructure.png)

√áa commence √† bien prendre forme ! Maintenant, calculons la variation quotidienne en pourcentage.

Pour ce faire, nous avons besoin de la valeur du jour pr√©c√©dent. Comme nous utilisons des index, nous pouvons simplement la r√©cup√©rer en utilisant `i - 1`, puis calculer la variation.

```ts showLineNumbers filename="restructureData.ts" {8-9, 14-15}
export default function restructureData(timestamps: Date[], values: number[]) {
  console.log("=> Restructuring data...");

  const dailyStockData = [];
  for (let i = 0; i < timestamps.length; i++) {
    const date = timestamps[i];
    const value = values[i];
    const previousValue = values[i - 1];
    const percChange = (value - previousValue) / previousValue;

    dailyStockData.push({
      date,
      value,
      previousValue,
      percChange,
    });
  }

  return dailyStockData;
}
```

Oh ! Mais quelque chose ne va pas... La premi√®re valeur de `previousValue` est `undefined`, et le premier `percChange` est `NaN` ! üò±

![Une capture d'√©cran montrant les dates et valeurs affich√©es sous forme de tableau. La premi√®re ligne contient des valeurs undefined et NaN.](/assets/stock-market-simulator/previous-value.png)

En fait, c'est logique. Le premier jour est... le premier jour ! Il n'y a pas de valeur pr√©c√©dente. Lorsque la boucle commence, `i` est `0`, donc lorsque l'ordinateur cherche `i - 1`, il essaie d'acc√©der √† l'index `-1`, qui n'existe pas !

Corrigeons cela en rempla√ßant la premi√®re valeur de `percChange` par `0`.


```ts showLineNumbers filename="restructureData.ts" {19}
export default function restructureData(timestamps: Date[], values: number[]) {
  console.log("=> Restructuring data...");

  const dailyStockData = [];
  for (let i = 0; i < timestamps.length; i++) {
    const date = timestamps[i];
    const value = values[i];
    const previousValue = values[i - 1];
    const percChange = (value - previousValue) / previousValue;

    dailyStockData.push({
      date,
      value,
      previousValue,
      percChange,
    });
  }

  dailyStockData[0].percChange = 0;

  return dailyStockData;
}
```

Voil√† qui est mieux !

![Une capture d'√©cran montrant les dates et valeurs affich√©es sous forme de tableau. La valeur NaN a disparu.](/assets/stock-market-simulator/previous-value-fixed.png)

## Calcul du rendement

Nous avons maintenant tout ce qu'il nous faut pour calculer les rendements !

Cr√©ons une autre fonction, `getFinalAmount`, dans `helpers`. Cette fonction n√©cessitera trois param√®tres :
- `amount` : le montant investi, qui doit √™tre un `number`
- `startDate` : la `Date` de l'investissement
- `dailyStockData` : une liste d'objets contenant :
  - Une cl√© `percChange` avec une valeur de type `number`
  - Une cl√© `date` avec une valeur de type `Date`

Notez qu'il y a d'autres cl√©s dans les objets de `dailyStockData`, mais nous n'en avons pas besoin ici, donc inutile de les sp√©cifier.

D'abord, nous devons filtrer `dailyStockData` pour ne garder que les donn√©es √† partir de la date de l'investissement. Nous utilisons la m√©thode `.filter()` sur la liste pour cela, aux lignes 8‚Äì10.

Ensuite, nous cr√©ons une variable `let` appel√©e `adjustedAmount` (ligne 12), qui suivra l'√©volution de la valeur de notre investissement au fil du temps. Au d√©part, elle est √©gale au `amount` investi.

Dans la boucle, nous calculons les gains ou pertes journali√®res et ajustons `adjustedAmount` en cons√©quence (ligne 15).

Enfin, nous retournons `adjustedAmount` !


```ts showLineNumbers filename="getFinalAmount.ts"
export default function getFinalAmount(
  amount: number,
  startDate: Date,
  dailyStockData: { percChange: number; date: Date }[],
) {
  console.log("=> Calculating final amount...");

  const filteredDailyStockData = dailyStockData.filter((dailyData) =>
    dailyData.date >= startDate
  );

  let adjustedAmount = amount;

  for (const dailyData of filteredDailyStockData) {
    adjustedAmount += adjustedAmount * dailyData.percChange;
  }

  return adjustedAmount;
}
```

Dans `main.ts`, nous pouvons cr√©er les variables `amount` et `startDate` pour stocker le montant initial investi et la date de l‚Äôinvestissement, puis les passer √† notre nouvelle fonction.

Nous stockons le r√©sultat de la fonction `getFinalAmount` dans une nouvelle variable appel√©e `finalAmount`.


```ts showLineNumbers filename="main.ts" {2, 6-7, 13-15}
import getData from "./helpers/getData.ts";
import getFinalAmount from "./helpers/getFinalAmount.ts";
import restructureData from "./helpers/restructureData.ts";

const symbol = "AAPL";
const amount = 1000;
const startDate = new Date("2020-01-01");

const { timestamps, values } = await getData(symbol);

const dailyStockData = restructureData(timestamps, values);

const finalAmount = getFinalAmount(amount, startDate, dailyStockData);

console.log(finalAmount);
```

Et voici le r√©sultat ! √áa fonctionne ! Vous auriez aujourd'hui 3 266 $ (au 5 f√©vrier 2025) si vous aviez investi 1 000 $ dans Apple en janvier 2020.

![Une capture d'√©cran montrant le montant final investi.](/assets/stock-market-simulator/final-amount.png)

## Les r√©sultats

Cr√©ons une fonction pour mieux afficher les r√©sultats.

Dans `helpers`, cr√©ez la fonction `logResult`.

Pour `startDate`, nous pouvons la convertir en texte en utilisant `.toISOString()`, qui retourne la date d‚Äôinvestissement sous ce format : `"2020-01-01T00:00:00.000Z"`. Pour ne conserver que la date, nous s√©parons le texte avec `"T"`. La m√©thode `.split()` retourne une liste : `["2020-01-01", "00:00:00.000Z"]`. Comme nous avons seulement besoin de la date, nous utilisons l‚Äôindex `[0]`.


```ts showLineNumbers filename="logResult.ts"
export default function logResult(
  amount: number,
  symbol: string,
  startDate: Date,
  finalAmount: number,
) {
  console.log(
    `\nIf you had invested $${amount} in ${symbol} on ${
      startDate.toISOString().split("T")[0]
    }, you would have $${Math.round(finalAmount)} today.\n`,
  );
}
```

Nous pouvons maintenant utiliser cette fonction dans `main.ts`.

```ts showLineNumbers filename="main.ts" {4, 16}
import getData from "./helpers/getData.ts";
import getFinalAmount from "./helpers/getFinalAmount.ts";
import restructureData from "./helpers/restructureData.ts";
import logResult from "./helpers/logResult.ts";

const symbol = "AAPL";
const amount = 1000;
const startDate = new Date("2020-01-01");

const { timestamps, values } = await getData(symbol);

const dailyStockData = restructureData(timestamps, values);

const finalAmount = getFinalAmount(amount, startDate, dailyStockData);

logResult(amount, symbol, startDate, finalAmount);
```

Magnifique, n'est-ce pas ? üòç

![Une capture d'√©cran de VS Code montrant un script simulant le march√© boursier.](/assets/stock-market-simulator/final-result.png)

## Attendez une minute...

Tout fonctionne bien avec une `startDate` en janvier 2020... Mais que se passerait-il si la date de d√©part √©tait en 1970, avant qu'Apple n'entre en bourse ?

C'est impossible ! Notre code devrait avertir l'utilisateur.

Mettez √† jour `startDate` avec `"1950-01-01"` pour tester... Il retourne un montant, alors qu'il devrait produire une erreur.

Nous pouvons mettre √† jour `main.ts` pour comparer `startDate` avec la premi√®re date dans `timestamps`. Si `startDate` est ant√©rieure au premier `timestamp`, nous cr√©ons erreur avec un message explicite.

```ts showLineNumbers filename="main.ts" {8, 12-16}
import getData from "./helpers/getData.ts";
import getFinalAmount from "./helpers/getFinalAmount.ts";
import restructureData from "./helpers/restructureData.ts";
import logResult from "./helpers/logResult.ts";

const symbol = "AAPL";
const amount = 1000;
const startDate = new Date("1950-01-01");

const { timestamps, values } = await getData(symbol);

if (startDate < timestamps[0]) {
  throw new Error(
    "The company was not public at that time. Please choose a later date.",
  );
}

const dailyStockData = restructureData(timestamps, values);

const finalAmount = getFinalAmount(amount, startDate, dailyStockData);

logResult(amount, symbol, startDate, finalAmount);
```
<Callout type="info" emoji="üí°">
    Les erreurs sont tr√®s utiles pour arr√™ter l'ex√©cution de votre script et fournir un message √† l'utilisateur (ou √† vous-m√™me). Essayez toujours de r√©diger des messages clairs qui vous aideront √† d√©boguer facilement ou qui guideront l'utilisateur.
</Callout>

C'est bien mieux. Nous n'obtiendrons plus de r√©sultats impossibles ! Vous pouvez maintenant tester diff√©rentes valeurs pour `startDate` en toute s√©curit√©.

![Une capture d'√©cran montrant une erreur.](/assets/stock-market-simulator/error.png)

## Conclusion

F√©licitations ! Vous avez appris beaucoup de choses dans ce projet. Nous avons explor√© le site de Yahoo pour trouver leur API et r√©cup√©rer des donn√©es. Ensuite, nous avons trait√© ces donn√©es pour calculer des rendements en fonction d'un montant investi √† une date donn√©e. C'est un √©norme !

Maintenant, vous pouvez exp√©rimenter davantage avec ce script. Recherchez d'autres entreprises sur le site de Yahoo et copiez-collez leurs symboles. Testez diff√©rents montants et dates d‚Äôinvestissement !

Ou modifiez le code pour ajouter d‚Äôautres fonctionnalit√©s. Voici quelques id√©es :
- Comparer les rendements de plusieurs entreprises
- Investir dans plusieurs entreprises en m√™me temps
- Acheter et vendre des actions √† diff√©rentes dates

Amusez-vous bien ! üíÉüï∫

<NoticeEnd lang="fr"/>
