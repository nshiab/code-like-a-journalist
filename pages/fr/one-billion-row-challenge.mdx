---
title: Le d√©fi du milliard de lignes üò±
description: Un projet pour relever le d√©fi du milliard de lignes en utilisant TypeScript et la librairie Simple Data Analysis.
---

import { Callout } from "nextra/components";
import { NoticeIntro, NoticeEnd } from "../../components/Notices.jsx";

# Le d√©fi du milliard de lignes üò±

Bienvenue dans ce nouveau projet o√π nous allons exploiter un fichier CSV contenant un milliard de lignes. Oui, UN MILLIARD !

Il s'agit d'un d√©fi tr√®s amusant cr√©√© par [Gunnar Morling](https://www.morling.dev/blog/one-billion-row-challenge/).

> Votre mission, si vous l'acceptez, est en apparence simple : √©crire un programme en Java pour r√©cup√©rer les valeurs de temp√©rature √† partir d'un fichier texte et calculer les temp√©ratures minimale, moyenne et maximale par station m√©t√©o. Il y a juste un petit d√©tail : le fichier contient 1 000 000 000 de lignes !

Au lieu d'utiliser un programme en Java, nous allons bien s√ªr utiliser TypeScript, avec la librairie Simple Data Analysis (SDA) que j'ai cr√©√©e ([donnez-lui un ‚≠ê](https://github.com/nshiab/simple-data-analysis)). C'est une excellente occasion de tester sa puissance !

Si vous √™tes bloqu√© √† un moment donn√© dans ce projet, il peut √™tre utile de revoir les le√ßons pr√©c√©dentes expliquant les bases de SDA :
- [Donn√©es tabulaires](/simple-data-analysis/tabular-data)
- [Donn√©es g√©ospatiales](/simple-data-analysis/geospatial-data)
- [Visualisation des donn√©es](/simple-data-analysis/dataviz)

Nous utiliserons Deno et VS Code. Consultez la le√ßon [Installation](/first-steps/setup) si n√©cessaire.

C'est parti !

<NoticeIntro lang="fr" />

## Installation

Pour tout installer, utilisons [setup-sda](https://jsr.io/@nshiab/setup-sda) comme dans les le√ßons pr√©c√©dentes.

Cr√©ez un nouveau dossier, ouvrez-le avec VS Code et ex√©cutez : `deno -A jsr:@nshiab/setup-sda`

Ensuite, lancez `deno task sda` pour surveiller `main.ts` et ses d√©pendances.

![Une capture d'√©cran de VS Code apr√®s avoir ex√©cut√© setup-sda.](/assets/one-billion-row-challenge/setup.png)
<Callout type="info" emoji="üí°">
 Pour que SDA fonctionne correctement, il est pr√©f√©rable d'avoir au moins la version 2.1.9 de Deno. Pour v√©rifier votre version, vous pouvez ex√©cuter `deno --version` dans votre terminal. Pour la mettre √† jour, ex√©cutez simplement `deno upgrade`.
</Callout>

## Les donn√©es

Dans le d√©fi original, vous devez copier un r√©pertoire GitHub et ex√©cuter un script pour g√©n√©rer un fichier CSV contenant 1 milliard de lignes. Mais je l'ai fait pour vous et j'ai t√©l√©vers√© le fichier compress√© sur mon Google Drive.

[T√©l√©chargez les donn√©es ici](https://drive.google.com/file/d/1A_OCjRyHnCCMZbgT0Z5KN70pJXMA8TYD/view?usp=drive_link). Cela peut prendre quelques minutes car le fichier fait environ 4 Go.

Ensuite, placez-le dans votre dossier `data` et d√©compressez-le. La version d√©compress√©e du fichier CSV fait environ 13 Go.

Pour charger les donn√©es, copiez et collez ce code dans votre `main.ts`. Selon votre ordinateur, cela peut prendre de quelques secondes √† quelques minutes.


```ts showLineNumbers filename="main.ts"
import { SimpleDB } from "@nshiab/simple-data-analysis";

const sdb = new SimpleDB({ logDuration: true });

const table = sdb.newTable();

await table.loadData("sda/data/measurements.csv");
await table.logTable();

await sdb.done();
```
![Une capture d'√©cran de VS Code apr√®s avoir charg√© un milliard de lignes de donn√©es.](/assets/one-billion-row-challenge/load-data.png)

F√©licitations ! Vous venez de charger 1 000 000 000 de lignes de donn√©es ! Sur mon MacBook Pro M1 avec 16 Go de RAM, cela a pris environ 26 secondes. ü•≥

Selon la RAM disponible sur votre ordinateur, vous pourriez voir un dossier `.tmp` appara√Ætre dans votre projet. Si les donn√©es sont plus volumineuses que votre RAM, ce dossier sera utilis√© pour traiter toutes les donn√©es en stockant des morceaux pr√©trait√©s.

Ce dossier `.tmp` peut devenir assez volumineux. Sur mon ordinateur, apr√®s la premi√®re ex√©cution, il fait environ 8 Go.

<Callout type="info" emoji="üí°">
    Si vous voulez nettoyer votre cache, ex√©cutez `deno task clean`. Cela supprimera `.tmp`. Vous pouvez aussi le supprimer manuellement, mais n'oubliez pas de vider votre corbeille.
</Callout>

## Le d√©fi

Comme vous pouvez le voir ci-dessus, les donn√©es sont simplement une liste de villes avec des temp√©ratures.

Maintenant, le d√©fi est de calculer les temp√©ratures minimale, moyenne et maximale par ville. Les r√©sultats doivent √©galement √™tre tri√©s par ordre alphab√©tique des villes.

Le code est tr√®s simple avec SDA. Vous n'avez m√™me pas besoin de trier les lignes manuellement, car `summarize` le fait par d√©faut.


```ts showLineNumbers filename="main.ts"
import { SimpleDB } from "@nshiab/simple-data-analysis";

const sdb = new SimpleDB({ logDuration: true });

const table = sdb.newTable();
await table.loadData("sda/data/measurements.csv");
await table.summarize({
  values: "temp",
  categories: "city",
  summaries: ["min", "mean", "max"],
});
await table.logTable();

await sdb.done();
```
![Une capture d'√©cran de VS Code apr√®s avoir agr√©g√© un milliard de lignes de donn√©es.](/assets/one-billion-row-challenge/summarize.png)

Le chargement et l'agr√©gation du milliard de valeurs a pris moins de 50 secondes sur mon ordinateur avec SDA ! üöÄ

## Acc√©l√©rer les choses

Lorsque vous utilisez des m√©thodes comme `loadData` et `summarize`, SDA effectue diverses v√©rifications pour garder les m√©thodes faciles √† utiliser et √©viter les erreurs potentielles.

Cependant, lorsque vous travaillez avec un fichier aussi volumineux, ces v√©rifications peuvent prendre pas mal de temps...

Si vous connaissez SQL, vous pouvez √©crire et ex√©cuter vos propres requ√™tes pour faire exactement ce que vous voulez, sans aucun extras !

Voici comment ex√©cuter une requ√™te SQL qui rel√®ve le d√©fi. Notez que j'utilise `LIMIT 10` pour ne retourner que les 10 premi√®res lignes du r√©sultat, mais tous les calculs sont effectu√©s.


```ts showLineNumbers filename="main.ts"
import { SimpleDB } from "@nshiab/simple-data-analysis";

const sdb = new SimpleDB({ logDuration: true });

const result = await sdb.customQuery(`
SELECT city,
    MIN(temp) AS min_temp,
    ROUND(MEAN(temp), 1) AS mean_temp,
    MAX(temp) as max_temp
FROM read_csv('sda/data/measurements.csv')
GROUP BY city
ORDER BY city
LIMIT 10;
`,
  { returnDataFrom: "query" },
);

console.table(result);

await sdb.done();
```
![Une capture d'√©cran de VS Code apr√®s avoir agr√©g√© un milliard de lignes de donn√©es.](/assets/one-billion-row-challenge/sql.png)

Et cela s'ex√©cute en seulement... 16 secondes ! üí•üí•üí•

## Mais... comment ?

Bien que SDA soit une librairie TypeScript, sous le capot, elle utilise [DuckDB](https://duckdb.org/), un syst√®me de base de donn√©es ultra-rapide √©crit en C++.

Lorsque vous utilisez des m√©thodes comme `loadData` ou `summarize`, SDA traduit tout en SQL et demande √† DuckDB de l'ex√©cuter.

D'apr√®s mon exp√©rience, utiliser SDA est plus rapide que d'utiliser Python avec Pandas ou R avec le Tidyverse.

Pour tester et comparer les performances de la librairie, j'ai calcul√© la temp√©rature moyenne par d√©cennie et par ville en utilisant les temp√©ratures quotidiennes des [donn√©es climatiques ajust√©es et homog√©n√©is√©es du Canada](https://api.weather.gc.ca/collections/ahccd-annual), soit environ 1,7 Go avec 22 millions de lignes de donn√©es. Pour plus de d√©tails, consultez le [r√©pertoire GitHub de la librairie](https://github.com/nshiab/simple-data-analysis).

J'ai ex√©cut√© les m√™mes calculs avec **simple-data-analysis@4.0.1** (Node.js, Bun et Deno), **Pandas (Python)** et le **tidyverse (R)**.

Gr√¢ce √† DuckDB, **Simple Data Analysis** a √©t√© l'option la plus rapide.

![Un graphique montrant la dur√©e de traitement de plusieurs scripts dans diff√©rents langages](/assets/one-billion-row-challenge/big-file.png)

Cependant, rien ne vous emp√™che d'utiliser DuckDB avec [Python](https://duckdb.org/docs/api/python/overview.html) et [R](https://duckdb.org/docs/api/r). Mais vous n'aurez pas toutes les m√©thodes faciles √† utiliser et les exemples que j'ai √©crits pour SDA. üò¨

J'ai √©galement test√© les calculs g√©ospatiaux, qui sont encore en plein d√©veloppement avec DuckDB. Python et R restent les plus rapides pour le moment ! Encore une fois, pour plus de d√©tails, consultez le [r√©pertoire](https://github.com/nshiab/simple-data-analysis).

## Conclusion

Voil√†, c'est tout ! J'esp√®re que ce projet vous a convaincu de la performance de la librairie Simple Data Analysis.

Plus rien ne vous emp√™che d'analyser des ensembles de donn√©es massifs avec TypeScript maintenant ! üíÉüï∫

<NoticeEnd lang="fr" />
