---
title: Extraire des donn√©es avec GitHub Actions
description: Dans cette le√ßon, nous apprenons les bases de l'utilisation des GitHub Actions et des workflows, et nous les utilisons pour collecter des donn√©es.
---

import { Callout } from "nextra/components";
import { NoticeIntro, NoticeEnd } from "../../../components/Notices.jsx";

# Extraire des donn√©es avec GitHub Actions

GitHub est une plateforme pour stocker votre code, organiser votre travail, collaborer avec d'autres codeurs... mais c'est aussi un endroit o√π vous pouvez **ex√©cuter du code** ! ü§©

Les GitHub Actions sont principalement utilis√©es pour ex√©cuter automatiquement des tests et des d√©ploiements pour des projets. Mais pour les amateurs de donn√©es comme nous, elles peuvent aussi servir √† faire du *web scraping*.

Dans cette le√ßon, nous r√©utilisons le code des le√ßons pr√©c√©dentes qui r√©cup√®re et extrait la temp√©rature la plus r√©cente √† Montr√©al. Mais cette fois, nous utiliserons les GitHub Actions pour le d√©clencher toutes les heures et accumuler les donn√©es ‚Äî gratuitement !  
Si vous voulez voir le projet final, [c‚Äôest par ici](https://github.com/nshiab/temperature-scraper).

Si ce n'est pas d√©j√† fait, je vous recommande fortement de suivre les deux le√ßons pr√©c√©dentes ([Qu‚Äôest-ce que Git ?](/git-and-github/git-basics) et [Qu‚Äôest-ce que GitHub ?](/git-and-github/github-basics)) avant de commencer celle-ci. Je pars du principe que vous avez un compte GitHub et que vous connaissez les commandes Git de base.

<NoticeIntro lang="fr" />

## Configuration

Cr√©ez un nouveau dossier et ouvrez-le avec VS Code.

√Ä l‚Äôint√©rieur, cr√©ez un fichier `main.ts` avec le code ci-dessous. Voici ce qu‚Äôil fait :
- Il r√©cup√®re les derni√®res donn√©es m√©t√©o √† Montr√©al depuis l' [API du Service m√©t√©orologique du Canada](https://eccc-msc.github.io/open-data/msc-data/obs_station/readme_obs_insitu_swobdatamart_en/).
- Les donn√©es sont au format XML. On utilise la librairie [`fast-xml-parser`](https://www.npmjs.com/package/fast-xml-parser) pour les convertir en JSON.
- Ensuite, on extrait la temp√©rature et l‚Äôheure depuis le JSON imbriqu√©. On cr√©e aussi une variable avec l‚Äôheure actuelle de la collecte.
- Enfin, on ajoute les donn√©es extraites dans le fichier `data.csv`.

Chaque fois que ce script s‚Äôex√©cute, une nouvelle ligne est ajout√©e au CSV. Les donn√©es s‚Äôaccumulent donc au fil du temps.

```ts showLineNumbers filename="main.ts"
import { XMLParser } from "fast-xml-parser";

const response = await fetch(
  "https://dd.weather.gc.ca/observations/swob-ml/latest/CWTQ-AUTO-minute-swob.xml",
);
const xml = await response.text();
const json = new XMLParser({ ignoreAttributes: false }).parse(xml);

const observation =
  json["om:ObservationCollection"]["om:member"]["om:Observation"];

const resultTime =
  observation["om:resultTime"]["gml:TimeInstant"]["gml:timePosition"];
console.log(resultTime);

const elements = observation["om:result"]["elements"]["element"];
type element = {
  "@_name": string;
  "@_value": string;
};
const temp = elements
  .find((d: element) => d["@_name"] === "air_temp")["@_value"];
console.log(temp);

const scrapeTime = new Date().toISOString();
console.log(scrapeTime);

await Deno.writeTextFile(
  "./data.csv",
  `\n${scrapeTime},${resultTime},${temp}`,
  {
    append: true,
  },
);
```

`main.ts` a besoin d‚Äôun fichier `data.csv`, alors cr√©ons-en un dans le dossier du projet.

```csv showLineNumbers filename="data.csv"
scrapeTime,resultTime,temp
```

Nous allons pousser ce projet sur GitHub, alors ajoutons un fichier `README.md` pour le rendre plus pr√©sentable.

```md showLineNumbers filename="README.md"
# Montreal temperature scraper

Every hour, this project retrieves the latest temperature in Montreal
from the [Meteorological Service of Canada API](https://eccc-msc.github.io/open-data/msc-data/obs_station/readme_obs_insitu_swobdatamart_en/)
and appends a new row to the `data.csv` file.
```

Testons ce code!

D'abord, installez `fast-xml-parser` :
- `deno add npm:fast-xml-parser`

Puis ex√©cutez `main.ts` :
- `deno -A main.ts`

Vous devriez voir la temp√©rature s‚Äôafficher et une ligne ajout√©e au fichier `data.csv` !

![Le README.](/assets/git-and-github/github-actions/setup.png)

## Cr√©er un nouveau d√©p√¥t GitHub

Initialisons un nouveau d√©p√¥t Git et poussons-le sur GitHub.

D‚Äôabord, on l‚Äôinitialise et on fait un premier commit :
- `git init`
- `git add -A`
- `git commit -m "First commit"`

Ensuite, cr√©ez un nouveau d√©p√¥t sur GitHub.

![Nouveau d√©p√¥t sur GitHub.](/assets/git-and-github/github-actions/new-repo.png)

Donnez-lui un nom et une description (facultatif). Vous pouvez le rendre priv√© ou public, comme vous le souhaitez.

Vous n‚Äôavez pas besoin de `README`, car nous en avons d√©j√† cr√©√© un. Pas besoin non plus de `.gitignore`, ni de licence pour le moment.

Puis cliquez sur `Create repository`.

![Param√®tres pour un nouveau d√©p√¥t GitHub.](/assets/git-and-github/github-actions/repo-settings.png)

Copiez les commandes *to push an existing repository from the command line*.

![Commandes pour synchroniser avec le nouveau d√©p√¥t GitHub.](/assets/git-and-github/github-actions/commands.png)

Et ex√©cutez ces commandes dans le terminal de votre projet.

![D√©p√¥t synchronis√© avec le nouveau d√©p√¥t GitHub.](/assets/git-and-github/github-actions/first-push.png)

Maintenant, si vous actualisez la page de votre d√©p√¥t GitHub, vous verrez votre code et le fichier `README.md` juste en dessous.

![Un d√©p√¥t fra√Æchement cr√©√© sur GitHub](/assets/git-and-github/github-actions/fresh-repo.png)

## Ajouter un workflow

M√™me si cela s‚Äôappelle *GitHub Actions*, vous ne cr√©ez pas des *actions*, mais des **workflows**. Et vous pouvez voir vos workflows dans l‚Äôonglet `Actions`.

![L‚Äôonglet Actions dans un nouveau d√©p√¥t GitHub.](/assets/git-and-github/github-actions/actions.png)

Pour l‚Äôinstant, il n‚Äôy a aucun workflow dans notre d√©p√¥t. GitHub nous en sugg√®re quelques-uns. N‚Äôh√©sitez pas √† les explorer, mais nous allons en ajouter un manuellement.

![Actions sugg√©r√©es par GitHub.](/assets/git-and-github/github-actions/no-actions.png)

Pour que GitHub d√©tecte automatiquement les workflows dans le d√©p√¥t, nous devons cr√©er des fichiers YAML dans `.github/workflows/`.

YAML signifie *YAML Ain‚Äôt Markup Language* ‚Äî mais pour moi, √ßa ressemble quand m√™me un peu √† du markup en plus strict. L‚Äôindentation, par exemple, est tr√®s importante. C‚Äôest un format tr√®s courant pour les fichiers de configuration. Ce n‚Äôest pas compliqu√©, et nous allons en √©crire ensemble, donc ne vous en faites pas.

Cr√©ons donc les dossiers n√©cessaires et un nouveau fichier `.github/workflows/scrape.yml`. Laissons-le vide pour l‚Äôinstant.

Validez-le et poussez-le sur GitHub :
- `git add -A`
- `git commit -m "Adding scrape.yml"`
- `git push`

![Un fichier .yml vide.](/assets/git-and-github/github-actions/YML.png)

Apr√®s quelques secondes, si vous actualisez la page Actions de votre d√©p√¥t, vous verrez que GitHub a d√©tect√© automatiquement votre workflow ! Mais comme le fichier est vide, il √©choue.

![Workflow √©chou√©.](/assets/git-and-github/github-actions/failed.png)

## √âcrire un workflow

Faisons cela √©tape par √©tape.

### Nom et √©v√©nements

Quand vous cr√©ez un workflow, vous devez d‚Äôabord lui donner un nom et d√©finir quand il doit √™tre d√©clench√©.

Ci-dessous, on indique √† GitHub de d√©clencher ce workflow dans trois situations :
- `push` signifie lorsqu‚Äôon pousse du nouveau code dans la branche `main`. Notez l‚Äôindentation ‚Äî elle indique la hi√©rarchie et les regroupements.
- `workflow_dispatch` signifie qu‚Äôon pourra cliquer sur un bouton pour d√©clencher manuellement le workflow. Toujours pratique.
- `schedule` d√©finit un **cron job**, c‚Äôest-√†-dire une mani√®re d‚Äôex√©cuter des scripts √† intervalles r√©guliers. Ici, `0 * * * *` signifie que le workflow s‚Äôex√©cutera au d√©but de chaque heure (minute `0`).



```yml showLineNumbers filename=".github/workflows/scrape.yml" {1-9}
name: Scrape Montreal temperature

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"
```
<Callout type="info" emoji="üí°">
   Les cron jobs sont largement utilis√©s, mais leur syntaxe n‚Äôest pas tr√®s intuitive. J‚Äôutilise souvent [crontab.guru](https://crontab.guru/) pour m‚Äôy retrouver. Il est aussi important de noter que les cron jobs dans les workflows GitHub ne sont pas parfaitement pr√©cis. Quand votre workflow doit s‚Äôex√©cuter, GitHub le place dans une file d‚Äôattente en attendant qu‚Äôune machine virtuelle soit disponible. Il peut donc se lancer avec quelques minutes de retard. Pour la plupart des t√¢ches de web scraping, ce n‚Äôest pas un probl√®me. Mais si vous avez besoin de lancer des scripts critiques √† des horaires tr√®s pr√©cis, GitHub Actions n‚Äôest peut-√™tre pas la meilleure solution.
</Callout>

### Jobs

Nous devons maintenant d√©crire les **jobs** que nous voulons que le workflow accomplisse. Un workflow peut contenir plusieurs jobs. Ici, nous n‚Äôen avons qu‚Äôun seul, que nous appelons `scrape`.

Nous indiquons √† GitHub que nous voulons l‚Äôex√©cuter sur une machine virtuelle avec la derni√®re version d‚ÄôUbuntu. Cela signifie qu‚Äôil s‚Äôex√©cutera sur une machine virtuelle peu co√ªteuse, ce qui nous convient parfaitement. Mais vous avez [le choix](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions#choosing-github-hosted-runners) si vous avez besoin de quelque chose de diff√©rent.

Notre script `main.ts` √©crit les donn√©es fra√Æchement collect√©es dans `data.csv`, donc nous devons donner au workflow la permission d‚Äô√©crire et de modifier les fichiers du d√©p√¥t.



```yml showLineNumbers filename=".github/workflows/scrape.yml" {11-15}
name: Scrape Montreal temperature

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write
```

### Steps

Il ne reste plus qu‚Äô√† indiquer √† GitHub les **√©tapes** de ce job. Chaque √©tape a un nom :
- `Checking out the repo` indique au workflow d‚Äôacc√©der au d√©p√¥t. On utilise pour cela l‚Äôaction pr√™te √† l‚Äôemploi `actions/checkout@v4`. Il existe beaucoup d‚Äôactions disponibles, notamment pour les t√¢ches courantes. C‚Äôest agr√©able de ne pas avoir √† tout coder soi-m√™me ! ü•≥
- `Set up Deno` installe Deno. L√† aussi, on utilise une action existante. On pr√©cise que l‚Äôon veut la version 2 de Deno.
- `Run main.ts` ex√©cute notre script, comme on le ferait localement.


```yml showLineNumbers filename=".github/workflows/scrape.yml" {16-26}
name: Scrape Montreal temperature

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checking out the repo
        uses: actions/checkout@v4
      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Run main.ts
        run: deno -A main.ts
```

### Sauvegarder les donn√©es

Maintenant, si vous validez votre workflow et que vous le poussez sur GitHub, il va r√©cup√©rer les donn√©es et les √©crire dans `data.csv`, mais... il ne va **pas vraiment sauvegarder `data.csv`** !

Souvenez-vous : cela s‚Äôex√©cute sur une machine virtuelle. Donc le script s‚Äôex√©cute, ajoute une nouvelle ligne √† `data.csv`, puis la machine est d√©truite et supprim√©e. Les donn√©es enregistr√©es en m√©moire disparaissent...

C‚Äôest pourquoi on ajoute une derni√®re √©tape pour **committer les modifications**. On cr√©e un utilisateur Git appel√© `Automated` qui committe et pousse les changements dans le fichier `data.csv`. G√©nial, non ? üôå


```yml showLineNumbers filename=".github/workflows/scrape.yml" {25-26}
name: Scrape Montreal temperature

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checking out the repo
        uses: actions/checkout@v4
      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Run main.ts
        run: deno -A main.ts
      - name: Commit changes
        run: git config user.name "Automated" && git config user.email "actions@users.noreply.github.com" && git add data.csv && git commit -m "Automated update" && git push
```

Enregistrez le fichier et poussez-le sur GitHub :
- `git add -A`
- `git commit -m "Updating workflow"`
- `git push`

Et maintenant, si vous actualisez l‚Äôonglet Actions de votre d√©p√¥t, vous verrez que votre workflow s‚Äôex√©cute correctement !

![Workflow r√©ussi.](/assets/git-and-github/github-actions/success.png)

Si vous cliquez dessus, vous verrez les jobs. Ici, il n‚Äôy en a qu‚Äôun : `scrape`.

![Job r√©ussi.](/assets/git-and-github/github-actions/success-jobs.png)

Et si vous cliquez sur le job, vous verrez les √©tapes, et vous pouvez cliquer sur chacune. C‚Äôest utile quand quelque chose √©choue ‚Äî vous pourrez voir les messages d‚Äôerreur ici.

![√âtapes du job r√©ussi.](/assets/git-and-github/github-actions/success-steps.png)

Si vous retournez sur la page d‚Äôaccueil du d√©p√¥t, vous verrez que le dernier commit a √©t√© fait par l‚Äôutilisateur Git `Automated` que nous avons configur√© dans le workflow.

![Commit automatis√©.](/assets/git-and-github/github-actions/automated-commit.png)

Et si vous regardez le fichier `data.csv`, vous verrez qu‚Äôune deuxi√®me ligne a √©t√© ajout√©e !

![Le fichier data.csv mis √† jour.](/assets/git-and-github/github-actions/data.csv.png)

Vous pouvez m√™me aller plus loin et consulter le commit pour voir le changement exact.

D‚Äôailleurs, c‚Äôest une excellente fa√ßon de voir ce qui a chang√© dans des pages web, des fichiers de donn√©es, et plus encore. Si vous scrapez des fichiers complets, GitHub pourra vous dire ce qui a chang√©, et quand. Vous aurez un historique complet et d√©taill√© gr√¢ce aux commits.

![Le commit d√©taill√©.](/assets/git-and-github/github-actions/commit.png)

Ce workflow s‚Äôest ex√©cut√© lorsqu‚Äôon a pouss√© sur `main`. Mais maintenant, il s‚Äôex√©cutera automatiquement chaque heure gr√¢ce √† notre cron job !

Avant GitHub Actions, il aurait fallu payer pour h√©berger un serveur capable de faire ce scraping √† intervalle r√©gulier. Mais maintenant, vous pouvez le faire gratuitement avec un simple fichier YAML ! üíÉüï∫

## R√©cup√©rer les donn√©es

Les donn√©es valid√©es sont sur GitHub. Pour les r√©cup√©rer dans votre d√©p√¥t local, il suffit de faire un `pull` :
- `git pull`

Note : je suis all√© manger avant de prendre cette capture d‚Äô√©cran ‚Äî j‚Äôai donc trois lignes ! Le scraper a tourn√© pendant que j‚Äô√©tais parti ! üòÑ

![Les donn√©es apr√®s un pull.](/assets/git-and-github/github-actions/pull.png)

Si votre d√©p√¥t est public, vous pouvez aussi r√©cup√©rer facilement le fichier CSV. C‚Äôest utile quand vous voulez utiliser des donn√©es √† jour dans un autre projet. Cliquez sur le bouton `Raw` pour obtenir une URL directe vers le fichier.

![Lien vers le fichier CSV brut.](/assets/git-and-github/github-actions/raw.png)

Vous pouvez maintenant aller chercher directement cette URL.

![Lien vers les donn√©es brutes.](/assets/git-and-github/github-actions/url.png)

Vous pouvez utiliser cette URL pour r√©cup√©rer les derni√®res donn√©es et les traiter ‚Äî par exemple avec la [librairie Simple Data Analysis](https://github.com/nshiab/simple-data-analysis).



```ts showLineNumbers
import { SimpleDB } from "@nshiab/simple-data-analysis";

const sdb = new SimpleDB();

const temperatures = sdb.newTable();
await temperatures.loadData(
  "https://raw.githubusercontent.com/nshiab/temperature-scraper/refs/heads/main/data.csv",
);
await temperatures.logTable();

await sdb.done();
```
![R√©cup√©rer les donn√©es avec la librairie Simple Data Analysis.](/assets/git-and-github/github-actions/fetch-test.png)

## D√©clencher un workflow manuellement

En ce moment, notre script de collecte est d√©clench√© lorsqu‚Äôon pousse du nouveau code sur `main` et chaque heure, au d√©but de l‚Äôheure.

Mais comme nous avons ajout√© `workflow_dispatch` dans notre configuration, on peut aussi le d√©clencher manuellement en cliquant dessus depuis la page Actions.

![D√©clenchement manuel du workflow.](/assets/git-and-github/github-actions/manual.png)

## D√©sactiver un workflow

Pour supprimer un workflow, il faut supprimer le fichier YAML du d√©p√¥t et valider/pousser ce changement.

Mais parfois, on veut simplement le d√©sactiver temporairement ‚Äî par exemple pendant qu‚Äôon corrige quelque chose dans le code, parce qu‚Äôon n‚Äôa pas besoin des donn√©es pour l‚Äôinstant, ou parce qu‚Äôon a atteint la limite de son compte GitHub gratuit ! üò¨

Pour d√©sactiver un workflow tout en gardant le fichier de configuration dans le d√©p√¥t, cliquez sur le workflow dans la barre lat√©rale gauche, puis sur le bouton `...` en haut √† droite, et enfin sur `Disable workflow`.

Pas d‚Äôinqui√©tude ‚Äî vous pourrez le r√©activer plus tard sans aucun probl√®me.

![D√©sactiver un workflow.](/assets/git-and-github/github-actions/disable.png)

## Conclusion

F√©licitations ! Vous savez maintenant comment cr√©er des workflows simples. J‚Äôai rendu [mon d√©p√¥t public](https://github.com/nshiab/temperature-scraper), alors n‚Äôh√©sitez pas √† le forker pour vos futurs projets.

Vous pouvez utiliser √ßa pour faire du scraping de donn√©es ‚Äî mais aussi pour plein d‚Äôautres choses ! C‚Äôest du code, donc les possibilit√©s sont infinies ! Avec ce que vous avez appris dans cette le√ßon, vous serez capable de comprendre et reproduire des workflows plus sophistiqu√©s que vous croiserez.

J‚Äôesp√®re que vous avez trouv√© cette le√ßon int√©ressante. Mais nous n‚Äôavons pas encore explor√© tout ce que GitHub a √† offrir... Dans la prochaine le√ßon, nous d√©couvrirons GitHub Pages, qui permet de cr√©er des sites web... tenez-vous bien... gratuitement ! Et puisque vous connaissez maintenant les GitHub Actions, vous pourrez republier vos pages automatiquement √† chaque fois que vous poussez du code sur la branche `main`. ü§ì

√Ä la prochaine le√ßon !

<NoticeEnd />
